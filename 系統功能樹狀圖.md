# 🍷 酒類貿易系統 - 功能樹狀圖

## 📋 核心業務流程

```
酒類貿易 ERP 系統
│
├─ 👥 人員管理
│   ├─ User (使用者)
│   │   ├─ SUPER_ADMIN (超級管理員) - 全權限
│   │   ├─ EMPLOYEE (員工) - 基本營運權限
│   │   └─ INVESTOR (投資方) - 受限查詢權限
│   │
│   └─ 權限隔離機制
│       └─ INVESTOR 只能看公司資金 (COMPANY) 的數據
│
├─ 📦 採購 → 進貨流程
│   │
│   ├─ 1️⃣ 【採購單】Purchase
│   │   ├─ 建立採購單
│   │   ├─ PurchaseItem (採購明細)
│   │   └─ 供應商資訊
│   │
│   ├─ 2️⃣ 【進貨單】Import (v2 新版)
│   │   ├─ 從採購單創建進貨單
│   │   ├─ ImportItem (進貨明細)
│   │   ├─ 匯率設定 (exchange_rate)
│   │   ├─ 報關資訊
│   │   │   ├─ 報單號碼 (declaration_number)
│   │   │   ├─ 報關日期 (declaration_date)
│   │   │   └─ 海關抽驗數量 (customs_seized)
│   │   │
│   │   ├─ 費用記錄 → ImportCost
│   │   │   ├─ SHIPPING (運費)
│   │   │   ├─ INSPECTION (檢驗費)
│   │   │   ├─ STORAGE (倉儲費)
│   │   │   ├─ CUSTOMS (報關費)
│   │   │   └─ OTHER (其他)
│   │   │
│   │   └─ 成本計算
│   │       ├─ 商品成本 (total_value)
│   │       ├─ 關稅 (total_taxes)
│   │       ├─ 額外費用 (ImportCost 總和)
│   │       └─ 最終成本 = 以上三者加總
│   │
│   ├─ 3️⃣ 【收貨】POST /api/imports-v2/[id]/receive
│   │   ├─ 標記為已收貨 (status: RECEIVED)
│   │   ├─ 更新庫存
│   │   │   ├─ Inventory (公司倉/個人倉)
│   │   │   ├─ ProductVariant.stock_quantity
│   │   │   └─ InventoryMovement (異動記錄)
│   │   │
│   │   └─ 設定初始成本價
│   │       └─ 成本 = (商品總價 + 關稅) / 實收數量
│   │
│   └─ 4️⃣ 【成本結算】POST /api/imports-v2/[id]/finalize
│       ├─ 計算最終成本 (含所有延後費用)
│       ├─ 更新剩餘庫存成本
│       ├─ 🔄 回溯調整已售商品成本與利潤
│       ├─ 建立 CostAdjustmentLog (調整記錄)
│       └─ 發送通知給 SUPER_ADMIN
│
├─ 📊 庫存管理
│   │
│   ├─ Product (商品主檔)
│   │   ├─ 商品資訊 (名稱、類別、產地)
│   │   └─ ProductVariant (商品規格)
│   │       ├─ 規格資訊 (容量、酒精度、年份)
│   │       ├─ stock_quantity (總庫存)
│   │       ├─ available_stock (可用庫存)
│   │       └─ current_price (當前售價)
│   │
│   ├─ Inventory (獨立庫存表)
│   │   ├─ warehouse: COMPANY (公司倉)
│   │   ├─ warehouse: PERSONAL (個人倉)
│   │   ├─ quantity (庫存數量)
│   │   ├─ available (可用數量)
│   │   └─ cost_price (成本價)
│   │
│   ├─ InventoryMovement (庫存異動)
│   │   ├─ IMPORT (進貨) → quantity_change > 0
│   │   ├─ SALE (銷售) → quantity_change < 0
│   │   ├─ TRANSFER (調撥)
│   │   ├─ ADJUSTMENT (盤點調整)
│   │   └─ 關聯 reference_id + reference_type
│   │
│   └─ StockTransfer (庫存調撥)
│       └─ 公司倉 ↔ 個人倉
│
├─ 💰 銷售 → 出貨流程
│   │
│   ├─ 1️⃣ 【報價單】Quotation (可選)
│   │   ├─ 建立報價
│   │   ├─ 客戶審核
│   │   └─ 轉為銷售單
│   │
│   ├─ 2️⃣ 【銷售單】Sale
│   │   ├─ 建立銷售單
│   │   │   ├─ 選擇客戶 (Customer)
│   │   │   ├─ 選擇商品 (ProductVariant)
│   │   │   ├─ 資金來源 (funding_source)
│   │   │   │   ├─ COMPANY (公司資金)
│   │   │   │   └─ PERSONAL (個人資金)
│   │   │   └─ SaleItem (銷售明細)
│   │   │       ├─ quantity (數量)
│   │   │       ├─ unit_price (單價)
│   │   │       ├─ cost_price (成本價)
│   │   │       └─ profit (毛利)
│   │   │
│   │   ├─ 訂單類型
│   │   │   ├─ 一般訂單 (is_preorder: false)
│   │   │   └─ 預購訂單 (is_preorder: true)
│   │   │       ├─ expected_arrival_date (預計到貨日)
│   │   │       ├─ BackorderTracking (缺貨追蹤)
│   │   │       └─ 到貨後轉正式訂單
│   │   │
│   │   ├─ 訂單狀態 (status)
│   │   │   ├─ DRAFT (草稿)
│   │   │   ├─ CONFIRMED (已確認)
│   │   │   ├─ COMPLETED (完成)
│   │   │   └─ CANCELLED (取消)
│   │   │
│   │   ├─ 付款狀態
│   │   │   ├─ payment_status: UNPAID/PARTIAL/PAID
│   │   │   ├─ is_paid: true/false
│   │   │   └─ paid_at (付款時間)
│   │   │
│   │   └─ 金額計算
│   │       ├─ total_amount (總金額)
│   │       ├─ actual_amount (實收金額)
│   │       └─ commission (傭金) ← 🔒 INVESTOR 看不到
│   │
│   ├─ 3️⃣ 【確認出貨】POST /api/sales/[id]/ship
│   │   ├─ 檢查庫存是否足夠
│   │   ├─ 檢查是否已付款 (is_paid: true)
│   │   ├─ 扣減庫存
│   │   │   ├─ Inventory.quantity -= shipped_quantity
│   │   │   ├─ ProductVariant.stock_quantity -= shipped_quantity
│   │   │   └─ 創建 InventoryMovement (SALE)
│   │   │
│   │   └─ 標記已出貨
│   │
│   └─ 4️⃣ 【出貨單】ShippingOrder
│       ├─ 從銷售單創建出貨單
│       │   └─ 條件: is_paid = true
│       │
│       ├─ 出貨單號: SH{日期}{序號}
│       ├─ ShippingItem (出貨明細)
│       ├─ 出貨狀態
│       │   ├─ READY (待出貨)
│       │   ├─ SHIPPED (已出貨)
│       │   ├─ DELIVERED (已送達)
│       │   └─ CANCELLED (已取消)
│       │
│       └─ ⚠️ 缺少功能
│           ├─ ❌ 運費記錄 (shipping_fee)
│           ├─ ❌ 包裝費 (packaging_fee)
│           └─ ❌ 類似 ImportCost 的費用系統
│
├─ 💳 財務管理
│   │
│   ├─ 應收帳款 (AccountsReceivable)
│   │   ├─ 來源: Sale
│   │   ├─ 收款記錄: PaymentRecord
│   │   └─ 帳齡分析
│   │
│   ├─ 應付帳款 (AccountsPayable)
│   │   ├─ 來源: Purchase
│   │   ├─ 付款記錄: SupplierPayment
│   │   └─ 付款狀態追蹤
│   │
│   ├─ 會計分錄 (AccountingEntry)
│   │   ├─ JournalEntry (傳票明細)
│   │   ├─ 借貸平衡檢查
│   │   └─ 財務報表基礎
│   │
│   └─ 現金流 (CashFlowRecord)
│       ├─ 收入記錄
│       ├─ 支出記錄
│       └─ LINE Bot 整合
│
├─ 📱 LINE Bot 整合
│   │
│   ├─ 現金流記錄
│   ├─ 成本試算
│   ├─ 稅金計算
│   └─ Gemini AI 助手
│
├─ 📈 報表分析
│   │
│   ├─ 儀表板 (Dashboard)
│   │   ├─ SUPER_ADMIN 儀表板
│   │   ├─ INVESTOR 儀表板 (受限)
│   │   └─ EMPLOYEE 儀表板
│   │
│   ├─ 銷售報表 (Reports)
│   │   ├─ 總覽報表
│   │   ├─ 銷售趨勢
│   │   ├─ 商品分析
│   │   ├─ 客戶分析
│   │   └─ Excel 匯出功能
│   │
│   └─ 財務報表
│       ├─ 損益表
│       ├─ 資產負債表
│       └─ 現金流量表
│
└─ ⚙️ 系統管理
    │
    ├─ 系統設定 (SystemSetting)
    ├─ 公司設定 (CompanySettings)
    ├─ 稽核日誌 (AuditLog)
    ├─ 通知系統 (Notification)
    └─ 資料庫健康檢查
```

---

## 🔄 完整業務流程圖

### 📥 進貨流程
```
採購單 (Purchase)
    ↓ 創建
進貨單 (Import v2)
    ├─ 設定匯率
    ├─ 上傳報單
    └─ 記錄費用 (ImportCost)
    ↓ 收貨
更新庫存 (Inventory + InventoryMovement)
    ├─ 公司倉 or 個人倉
    └─ 設定初始成本
    ↓ 結算
最終成本計算 (Finalize)
    ├─ 更新剩餘庫存成本
    ├─ 回溯調整已售商品
    └─ 創建調整記錄
```

### 📤 出貨流程
```
報價單 (Quotation) [可選]
    ↓ 轉換
銷售單 (Sale)
    ├─ 選擇客戶 (Customer)
    ├─ 選擇商品 (ProductVariant)
    ├─ 設定資金來源 (COMPANY/PERSONAL)
    └─ 計算金額、成本、利潤
    ↓ 確認
付款 (is_paid = true)
    └─ 記錄應收帳款 (AccountsReceivable)
    ↓ 出貨
確認出貨 (Ship)
    ├─ 檢查庫存
    ├─ 扣減庫存 (Inventory - quantity)
    └─ 創建庫存異動 (InventoryMovement: SALE)
    ↓ 創建
出貨單 (ShippingOrder)
    ├─ 出貨單號: SH{日期}{序號}
    ├─ 出貨明細 (ShippingItem)
    └─ ⚠️ 缺少運費/包裝費記錄
```

### 💰 財務流程
```
銷售收入
    ↓
應收帳款 (AccountsReceivable)
    ├─ 收款記錄 (PaymentRecord)
    └─ 帳齡分析
    ↓
會計分錄 (AccountingEntry)
    └─ 財務報表

採購支出
    ↓
應付帳款 (AccountsPayable)
    ├─ 付款記錄 (SupplierPayment)
    └─ 付款狀態追蹤
    ↓
會計分錄 (AccountingEntry)
    └─ 財務報表
```

---

## ⚠️ 目前系統缺口

### 1. 出貨費用管理
```
❌ 缺少功能:
   - 運費記錄 (shipping_fee)
   - 包裝費記錄 (packaging_fee)
   - 保險費記錄 (insurance_fee)
   - 類似 ImportCost 的 SaleCost 表

✅ 建議方案:
   創建 SaleCost 或 ShippingCost 表
   ├─ cost_type: SHIPPING | PACKAGING | INSURANCE | OTHER
   ├─ amount: 費用金額
   ├─ description: 費用描述
   └─ sale_id or shipping_order_id: 關聯銷售單/出貨單
```

### 2. 出貨單獨立性
```
⚠️ 目前狀況:
   - 出貨單使用 Sale 模型模擬
   - 透過 is_paid = true 篩選
   - 沒有獨立的出貨狀態管理

✅ 已有 ShippingOrder 模型:
   - 但目前未完全使用
   - 建議完全遷移到獨立 ShippingOrder 表
```

### 3. 庫存預留機制
```
❌ 缺少功能:
   - 銷售單確認時預留庫存
   - ProductVariant.available_stock 更新
   - 預留 vs 實際出貨的數量追蹤

✅ 建議:
   - 確認訂單: available_stock -= quantity (預留)
   - 確認出貨: stock_quantity -= quantity (實際扣減)
   - 取消訂單: available_stock += quantity (釋放預留)
```

---

## 📊 資料表關聯圖

```
User (使用者)
  ├─→ Purchase (採購單)
  ├─→ Import (進貨單)
  ├─→ Sale (銷售單)
  └─→ CashFlowRecord (現金流)

Customer (客戶)
  ├─→ Sale (銷售單)
  ├─→ Quotation (報價單)
  └─→ AccountsReceivable (應收帳款)

Product (商品)
  └─→ ProductVariant (規格)
      ├─→ Inventory (庫存)
      ├─→ PurchaseItem (採購明細)
      ├─→ ImportItem (進貨明細)
      ├─→ SaleItem (銷售明細)
      └─→ InventoryMovement (庫存異動)

Purchase (採購單)
  ├─→ PurchaseItem (明細)
  ├─→ Import (進貨單)
  └─→ AccountsPayable (應付帳款)

Import (進貨單)
  ├─→ ImportItem (明細)
  ├─→ ImportCost (費用)
  ├─→ CostAdjustmentLog (成本調整)
  └─→ InventoryMovement (庫存異動)

Sale (銷售單)
  ├─→ SaleItem (明細)
  ├─→ ShippingOrder (出貨單)
  ├─→ AccountsReceivable (應收帳款)
  ├─→ BackorderTracking (缺貨追蹤)
  └─→ InventoryMovement (庫存異動)
```

---

## 🎯 權限管理

```
SUPER_ADMIN (超級管理員)
  ├─ ✅ 全部功能
  ├─ ✅ 看到 actual_amount (實收金額)
  ├─ ✅ 看到 commission (傭金)
  ├─ ✅ 看到 cost_price (成本價)
  └─ ✅ 看到所有資金來源 (COMPANY + PERSONAL)

EMPLOYEE (員工)
  ├─ ✅ 基本營運功能
  ├─ ✅ 看到 actual_amount
  ├─ ✅ 看到 commission
  ├─ ✅ 看到 cost_price
  └─ ✅ 看到所有資金來源

INVESTOR (投資方)
  ├─ ❌ 只能看 COMPANY 資金來源
  ├─ ❌ 看不到 actual_amount
  ├─ ❌ 看不到 commission
  ├─ ❌ 看不到 cost_price
  └─ ✅ 可查看報表（受限數據）
```

---

**生成時間**: 2025-10-08
**系統版本**: v2 (imports v2 遷移完成)
