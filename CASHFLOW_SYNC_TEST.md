# 銷售單收支同步功能 - 測試指南

## 🎯 測試目標

驗證銷售單建立/確認/刪除時，cashflow 記錄能否正確同步。

---

## 📋 測試前準備

### 1. 確認環境
- ✅ 開發環境已啟動 (`npm run dev`)
- ✅ 已登入為 SUPER_ADMIN 帳號
- ✅ 資料庫有可用的客戶和商品

### 2. 開啟 Console Log 監控
在瀏覽器開發者工具中查看：
```
[Cashflow Sync] 銷售單 SA-xxx
  投資方期望: 10000
  實際收入: 12000
  利潤差額: 2000
[Cashflow Sync] ✅ 已產生 3 筆 cashflow 記錄
```

---

## 🧪 測試案例

### 測試 1: 建立銷售單（DRAFT 狀態）

**步驟**：
1. 進入「銷售管理」頁面 (`/sales`)
2. 點擊「新增銷售單」
3. 填寫：
   - 客戶：任選一位
   - 商品：選擇任意商品
   - 數量：1
   - **期望售價（投資方看到）**: 10000
   - **實際售價（超管可見）**: 12000
4. 點擊「儲存草稿」

**預期結果**：
- ✅ 銷售單建立成功，狀態為 `DRAFT`
- ✅ Console 顯示：`銷售單 SA-xxx 狀態 DRAFT，清除 cashflow 記錄`
- ✅ 到「收支記錄」頁面 (`/finance/cashflow`) 查詢，**不應有**該銷售單的記錄

**原因**：只有 CONFIRMED/SHIPPED/DELIVERED/PAID 狀態才產生 cashflow

---

### 測試 2: 確認銷售單（CONFIRMED 狀態）

**步驟**：
1. 在「銷售管理」找到剛才建立的銷售單
2. 點擊「確認訂單」
3. 系統檢查庫存後確認

**預期結果**：
- ✅ 銷售單狀態變為 `CONFIRMED`
- ✅ Console 顯示：
  ```
  [Cashflow Sync] 銷售單 SA-20251007001
    投資方期望: 10000
    實際收入: 12000
    利潤差額: 2000
  [Cashflow Sync] ✅ 已產生 3 筆 cashflow 記錄
  ```
- ✅ 到「收支記錄」頁面查詢，應該看到 **3 筆記錄**：

| 類型 | 金額 | 描述 | 分類 | 資金來源 | 備註 |
|------|------|------|------|----------|------|
| INCOME | 12000 | 銷售實際收入 - SA-xxx | SALES | INVESTOR | 利潤差額 2000 |
| EXPENSE | 10000 | 應付投資方 - SA-xxx | SETTLEMENT | INVESTOR | 投資方期望售價總額 |
| INCOME | 2000 | 銷售利潤 - SA-xxx | COMMISSION | PERSONAL | 實際成交價與投資方售價差額 |

---

### 測試 3: 刪除銷售單

**步驟**：
1. 先將銷售單「取消」（如果系統要求）
2. 點擊「刪除」按鈕
3. 確認刪除

**預期結果**：
- ✅ 銷售單刪除成功
- ✅ 到「收支記錄」頁面，剛才的 **3 筆記錄應該消失**
- ✅ 搜尋 `sale:xxx` 應該找不到任何記錄

---

## 🔍 進階測試

### 測試 4: 實際售價 = 期望售價（無利潤差額）

**步驟**：
建立銷售單時，期望售價和實際售價都填 **10000**

**預期結果**：
- ✅ 只產生 **2 筆** cashflow 記錄（實際收入 + 應付投資方）
- ✅ **不應產生**第 3 筆「銷售利潤」記錄（因為差額為 0）

---

### 測試 5: 實際售價 < 期望售價（虧損）

**步驟**：
- 期望售價：10000
- 實際售價：8000

**預期結果**：
- ✅ 產生 3 筆記錄
- ✅ 第 3 筆「銷售利潤」為 **EXPENSE**（支出）
- ✅ 金額：2000（虧損）

---

## 📊 檢查清單

完成以下測試後打勾：

- [ ] 測試 1: DRAFT 狀態不產生 cashflow ✅
- [ ] 測試 2: CONFIRMED 狀態產生 3 筆 cashflow ✅
- [ ] 測試 3: 刪除銷售單清空 cashflow ✅
- [ ] 測試 4: 無利潤差額只產生 2 筆記錄 ✅
- [ ] 測試 5: 虧損情況產生 EXPENSE 記錄 ✅

---

## 🐛 常見問題

### Q1: 找不到「收支記錄」頁面？
**A**: 路徑為 `/finance/cashflow`，或從側邊欄「財務管理 > 收支記錄」進入

### Q2: 看不到實際售價欄位？
**A**: 只有 SUPER_ADMIN 能看到，請確認登入帳號權限

### Q3: Console 沒有顯示 [Cashflow Sync] 訊息？
**A**:
1. 確認瀏覽器開發者工具 Console 已開啟
2. 檢查是否有過濾器隱藏了訊息
3. 後端 log 可能在終端機而非瀏覽器

### Q4: 刪除時報錯「無法刪除已確認的訂單」？
**A**: 需要先「取消訂單」再刪除，或使用「管理員強制取消」功能

---

## 📝 測試記錄範本

```
測試日期：2025-10-07
測試人員：[你的名字]
環境：開發環境

測試 1 - DRAFT 不產生 cashflow
- 銷售單號：SA-20251007001
- 結果：✅ 通過 / ❌ 失敗
- 備註：

測試 2 - CONFIRMED 產生 3 筆
- 銷售單號：SA-20251007001
- Cashflow 記錄數：3 筆
- 結果：✅ 通過 / ❌ 失敗
- 備註：

測試 3 - 刪除清空 cashflow
- 結果：✅ 通過 / ❌ 失敗
- 備註：
```

---

## 🚀 下一步

測試通過後：
1. ✅ 推送到 GitHub
2. 📝 更新 PLAN.MD 標記完成
3. 🔄 繼續實作方案 B（剩餘 API 整合）
