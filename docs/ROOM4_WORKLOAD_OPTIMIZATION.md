# 💰 Room-4工作量優化方案

## 🎯 優化目標

將Room-4（銷售會計房間）從過重的4-5週工作量優化到合理的3-4週，同時避免B螞蟻因Token限制而卡住。

---

## ⚖️ **原始工作量分析**

### **Room-4原始負責範圍**
```
💰 Room-4: 銷售財務房間
原工作量: 4-5週 ⚠️ 過重

包含功能：
1. 銷售訂單系統 (1.5週)
2. 雙重價格機制 (1週)
3. 會計模組 (1週)
4. 出貨單列印 (1週) ← 可移出
5. 對帳單功能 (0.5-1週) ← 可移出
6. 投資方數據隔離 (0.5週)
7. 開銷記錄與分攤 (0.5週)

Token估算: 150-180k (超出B螞蟻單次限制)
```

### **問題識別**
1. **功能混雜** - 銷售、會計、列印功能技術棧不同
2. **Token超載** - 單一房間Token需求過高
3. **依賴複雜** - 同時依賴多個其他房間的資料

---

## 🔄 **優化重新分配方案**

### **Room-4保留功能（核心）**
```
💰 Room-4: 銷售會計核心房間
優化後工作量: 3-4週 ✅ 合理

保留功能：
1. 銷售訂單系統 (1.5週)
   - 訂單建立、修改、取消
   - 商品選擇和數量管理
   - 價格計算邏輯

2. 雙重價格機制 (1週) ⚠️ 核心機密
   - 投資方看到的協議價格
   - 實際收款價格
   - 利潤分配邏輯

3. 基礎會計功能 (1週)
   - 銷售分錄產生
   - 應收帳款管理
   - 基本財務記錄

4. 投資方數據隔離 (0.5週) ⚠️ 安全關鍵
   - 銷售資料權限控制
   - 價格資訊隱藏邏輯
   - 報表資料過濾

Token估算: 100-120k (在B螞蟻可承受範圍)
```

### **移出功能重新分配**

#### **移出到Room-5（報表列印房間）**
```
📋 新增到Room-5：
1. 出貨單列印功能 (1週)
   - PDF模板設計
   - 資料格式化
   - 列印樣式控制

2. 對帳單生成功能 (0.5-1週)
   - 期間對帳邏輯
   - 帳務明細整理
   - 餘額計算

理由：
- 列印功能屬於報表範疇
- 技術棧相近（PDF生成、格式化）
- Room-5原本工作量較輕
```

#### **移出到Room-7（UI房間）**
```
🎨 新增到Room-7：
1. 銷售相關UI優化
   - 銷售單界面美化
   - 雙重價格顯示邏輯
   - 響應式設計適配

理由：
- UI工作屬於前端專業
- 可與其他UI組件一起優化
- 避免後端邏輯與前端混雜
```

---

## 🏗️ **Room-4詳細實作規劃**

### **階段1：銷售訂單基礎 (Token: 30-35k)**
```typescript
// A螞蟻監督任務
1. 銷售訂單資料模型設計確認
2. API端點規格review
3. 業務邏輯規則確認

// B螞蟻實作任務
1. Sales Order CRUD API實作
2. 訂單狀態管理
3. 基礎驗證邏輯

交接產出：
- 基礎銷售API完成
- 單元測試覆蓋
- API文檔更新
```

### **階段2：雙重價格機制 (Token: 35-40k)** 🔒
```typescript
// A螞蟻監督任務
1. 價格隔離邏輯設計確認
2. 安全性檢查規範
3. 測試案例設計

// B螞蟻實作任務
1. 價格計算引擎實作
2. 投資方價格過濾中間件
3. 安全性測試實作

⚠️ 關鍵重點：
- 投資方永遠看不到真實售價
- 利潤分配邏輯正確實作
- 資料洩漏防護機制

交接產出：
- 雙重價格系統完成
- 安全性測試通過
- 隔離機制驗證報告
```

### **階段3：會計整合 (Token: 25-30k)**
```typescript
// A螞蟻監督任務
1. 會計分錄規則確認
2. 應收帳款邏輯review
3. 財務報表需求確認

// B螞蟻實作任務
1. 銷售分錄自動產生
2. 應收帳款管理
3. 與會計模組整合

交接產出：
- 會計整合完成
- 分錄正確性驗證
- 財務資料一致性檢查
```

### **階段4：數據隔離與交接 (Token: 15-20k)**
```typescript
// A螞蟻監督任務
1. 最終安全性檢查
2. 整合測試驗證
3. 交接文檔review

// B螞蟻實作任務
1. 完整整合測試
2. 權限控制驗證
3. 交接報告撰寫

交接產出：
- 完整交接報告
- 部署說明文檔
- 已知問題清單
- 後續優化建議
```

---

## 📊 **其他房間工作量調整**

### **Room-5工作量變化**
```
原本: 2.5-3.5週
新增: +1.5週 (出貨單+對帳單)
調整後: 4-5週

但技術棧統一（都是報表相關），Token需求分散
```

### **Room-7工作量確認**
```
原規劃: 4-6週
包含: Dashboard + 像素CRM + UI組件 + 銷售UI優化
總計: 4-6週 (合理範圍)

UI工作可高度模組化，Token風險較低
```

---

## 🛡️ **Token風險控制**

### **Room-4專用Token管控**
```
總預算: 120k tokens
分配:
- 階段1: 35k (29%)
- 階段2: 40k (33%) ← 最重要階段
- 階段3: 30k (25%)
- 階段4: 15k (13%)

安全邊際: 80% (留20%給意外狀況)
```

### **緊急應變方案**
```
如果Token即將耗盡：
1. 立即commit當前代碼
2. 產出階段性交接說明
3. A螞蟻接手完成剩餘工作
4. 記錄問題供下次改進
```

---

## 📋 **驗收標準調整**

### **Room-4核心驗收項目**
```
✅ 銷售訂單功能完整
✅ 雙重價格機制正確實作
✅ 投資方資料隔離100%有效
✅ 會計分錄自動產生
✅ 應收帳款管理功能
✅ 安全性測試通過
✅ 整合測試成功
✅ 交接文檔完整
```

### **移出功能驗收**
```
Room-5負責驗收：
✅ 出貨單PDF生成
✅ 對帳單功能完整

Room-7負責驗收：
✅ 銷售UI響應式設計
✅ 雙重價格顯示正確
```

---

## 🎯 **優化效果評估**

### **工作量平衡度**
```
優化前: 4-5週 ⚠️ 過重
優化後: 3-4週 ✅ 合理

Token風險: 高 → 中等
技術複雜度: 混雜 → 專精
依賴關係: 複雜 → 清晰
```

### **整體房間平衡**
```
Room-1: 3-4週 ✅
Room-2: 2週 ✅
Room-3: 3-4週 ✅
Room-4: 3-4週 ✅ (優化後)
Room-5: 4-5週 ⚠️ (但技術棧統一)
Room-6: 2.5週 ✅
Room-7: 4-6週 ✅
```

**這個優化方案讓Room-4專注於核心銷售邏輯，避免Token超載，同時保持系統整體平衡！** ✅