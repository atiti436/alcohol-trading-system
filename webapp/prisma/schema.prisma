generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                          String               @id @default(cuid())
  email                       String               @unique
  name                        String
  image                       String?
  role                        Role                 @default(EMPLOYEE)
  investor_id                 String?
  is_active                   Boolean              @default(true)
  preferences                 Json?
  created_at                  DateTime             @default(now())
  updated_at                  DateTime             @updatedAt
  created_accounting_entries  AccountingEntry[]
  created_accounts_receivable AccountsReceivable[]
  created_payment_records     PaymentRecord[]
  created_accounts_payable    AccountsPayable[]
  created_supplier_payments   SupplierPayment[]
  created_purchases           Purchase[]
  created_quotations          Quotation[]
  created_sales               Sale[]
  created_cashflow_records    CashFlowRecord[]

  // ğŸ†• é‡æ§‹æ–°å¢çš„é—œè¯
  created_stock_transfers  StockTransfer[]
  created_imports          Import[]            @relation("ImportCreator")
  finalized_imports        Import[]            @relation("ImportFinalizer")
  created_import_costs     ImportCost[]
  created_cost_adjustments CostAdjustmentLog[]
  notifications            Notification[]

  @@map("users")
}

model Customer {
  id                   String                 @id @default(cuid())
  customer_code        String                 @unique
  name                 String
  contact_person       String?
  phone                String?
  email                String?
  company              String?
  tax_id               String?
  address              String?
  shipping_address     String?
  tier                 CustomerTier           @default(REGULAR)
  payment_terms        PaymentTerms           @default(CASH)
  requires_invoice     Boolean                @default(false)
  credit_limit         Float?
  notes                String?
  is_active            Boolean                @default(true)
  created_at           DateTime               @default(now())
  updated_at           DateTime               @updatedAt
  accounts_receivables AccountsReceivable[]
  special_prices       CustomerSpecialPrice[]
  quotations           Quotation[]
  sales                Sale[]
  shipping_orders      ShippingOrder[]

  @@map("customers")
}

// æ‡‰ä»˜å¸³æ¬¾åˆ†é¡
enum ApCategory {
  PURCHASE
  FREIGHT
  TAX
  WAREHOUSE
  ADMIN
  OTHER
}

model Product {
  id                  String          @id @default(cuid())
  product_code        String          @unique
  name                String
  category            AlcoholCategory
  volume_ml           Int
  alc_percentage      Float
  weight_kg           Float
  package_weight_kg   Float?
  total_weight_kg     Float?
  has_box             Boolean         @default(false)
  has_accessories     Boolean         @default(false)
  accessory_weight_kg Float?
  accessories         String[]
  hs_code             String?
  supplier            String?
  manufacturing_date  String?
  expiry_date         String?

  // ğŸ¯ ä¸‰å±¤åƒ¹æ ¼æ¶æ§‹ï¼ˆâš ï¸ DEPRECATED - 2025-10-01 èµ·çµ±ä¸€ä½¿ç”¨è®Šé«”å±¤ç´šåƒ¹æ ¼ï¼‰
  // @deprecated Product å±¤ç´šåƒ¹æ ¼å·²æ£„ç”¨ï¼Œè«‹ä½¿ç”¨ ProductVariant çš„åƒ¹æ ¼æ¬„ä½
  // Product åƒ…ä½œç‚ºå®¹å™¨ï¼Œå¯¦éš›åƒ¹æ ¼ç®¡ç†åœ¨è®Šé«”å±¤ç´š
  cost_price     Float @default(0) // @deprecated
  investor_price Float @default(0) // @deprecated
  actual_price   Float @default(0) // @deprecated
  standard_price Float @default(0) // @deprecated
  current_price  Float @default(0) // @deprecated
  min_price      Float @default(0) // @deprecated

  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // é—œè¯
  special_prices CustomerSpecialPrice[]
  variants       ProductVariant[]
  purchase_items PurchaseItem[]
  quotations     Quotation[]
  sale_items     SaleItem[]
  shipping_items ShippingItem[]

  @@map("products")
}

model ProductVariant {
  id           String @id @default(cuid())
  product_id   String
  variant_code String @unique
  variant_type String @db.VarChar(100)
  description  String

  // ğŸ¯ ä¸‰å±¤åƒ¹æ ¼æ¶æ§‹
  cost_price     Float  @default(0) // æˆæœ¬åƒ¹ï¼ˆçœŸå¯¦æˆæœ¬ï¼‰
  investor_price Float  @default(0) // æŠ•è³‡æ–¹æœŸæœ›å”®åƒ¹ï¼ˆINVESTOR å¯è¦‹å¯æ”¹ï¼‰
  actual_price   Float  @default(0) // å¯¦éš›å”®åƒ¹ï¼ˆåƒ… SUPER_ADMIN å¯è¦‹å¯æ”¹ï¼‰
  current_price  Float  @default(0) // é¡¯ç¤ºç”¨åƒ¹æ ¼ï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
  base_price     Float? // å‘ä¸‹ç›¸å®¹ï¼ˆä¿ç•™èˆŠè³‡æ–™ï¼‰

  discount_rate   Float?
  limited_edition Boolean @default(false)
  production_year Int?
  serial_number   String?
  condition       String  @default("Normal")

  // ğŸ“¦ åº«å­˜ç®¡ç† (ç§»è‡³ç¨ç«‹ Inventory è¡¨)
  // å‘ä¸‹ç›¸å®¹ï¼šä¿ç•™é€™äº›æ¬„ä½ä½†æ¨™è¨˜ç‚º deprecated
  stock_quantity  Int @default(0) // @deprecated è«‹ä½¿ç”¨ Inventory è¡¨
  reserved_stock  Int @default(0) // @deprecated è«‹ä½¿ç”¨ Inventory è¡¨
  available_stock Int @default(0) // @deprecated è«‹ä½¿ç”¨ Inventory è¡¨

  weight_kg Float @default(0)

  // âœ… åœç”¨æ©Ÿåˆ¶
  is_active Boolean @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  sku        String   @unique

  // é—œè¯
  inventory           Inventory[]
  inventory_movements InventoryMovement[]
  product             Product             @relation(fields: [product_id], references: [id], onDelete: Cascade)
  sale_items          SaleItem[]
  shipping_items      ShippingItem[]
  source_transfers    StockTransfer[]     @relation("SourceVariant")
  target_transfers    StockTransfer[]     @relation("TargetVariant")
  import_items        ImportItem[]

  @@map("product_variants")
}

// ğŸ­ ç¨ç«‹åº«å­˜è¡¨ (æ”¯æ´å¤šå€‰åº«)
model Inventory {
  id         String    @id @default(cuid())
  variant_id String
  warehouse  Warehouse // COMPANY æˆ– PRIVATE

  // ğŸ“¦ åº«å­˜æ•¸é‡
  quantity        Int     @default(0) // ç¸½åº«å­˜
  reserved        Int     @default(0) // å·²é ç•™ï¼ˆè¨‚å–®é–å®šï¼‰
  available       Int     @default(0) // å¯å”®åº«å­˜ = quantity - reserved

  // ğŸ’° æˆæœ¬åƒ¹ï¼ˆåŠ æ¬Šå¹³å‡ï¼‰
  cost_price      Decimal @default(0) @db.Decimal(10, 2)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // é—œè¯
  variant ProductVariant @relation(fields: [variant_id], references: [id], onDelete: Cascade)

  // å”¯ä¸€ç´„æŸï¼šä¸€å€‹è®Šé«”åœ¨åŒä¸€å€‹å€‰åº«åªèƒ½æœ‰ä¸€ç­†åº«å­˜è¨˜éŒ„
  @@unique([variant_id, warehouse])
  @@index([warehouse])
  @@map("inventories")
}

model CustomerSpecialPrice {
  id              String    @id @default(cuid())
  customer_id     String
  product_id      String
  standard_price  Float
  special_price   Float
  discount_amount Float
  discount_rate   Float
  reason          String
  effective_date  DateTime
  expiry_date     DateTime?
  is_active       Boolean   @default(true)
  notes           String?
  created_by      String
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  customer        Customer  @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  product         Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([customer_id, product_id])
  @@map("customer_special_prices")
}

model InventoryMovement {
  id              String   @id @default(cuid())
  variant_id      String
  movement_type   String
  adjustment_type String?
  reason          String
  notes           String?
  reference_id    String?
  reference_type  String?
  created_by      String?
  created_at      DateTime @default(now())
  quantity_after  Int
  quantity_before Int
  quantity_change Int
  total_cost      Float    @default(0)
  unit_cost       Float    @default(0)

  // ğŸª å€‰åº«æ¨™è¨˜
  warehouse Warehouse @default(COMPANY)

  variant ProductVariant @relation(fields: [variant_id], references: [id], onDelete: Cascade)

  @@index([warehouse])
  @@map("inventory_movements")
}

model Purchase {
  id                 String            @id @default(cuid())
  purchase_number    String            @unique
  funding_source     String
  supplier           String
  currency           String            @default("JPY")
  exchange_rate      Float
  total_amount       Float
  status             String            @default("PENDING")
  declaration_number String?
  declaration_date   DateTime?
  received_date      DateTime?
  notes              String?
  created_by         String
  created_at         DateTime          @default(now())
  updated_at         DateTime          @updatedAt
  receipts           GoodsReceipt[]
  items              PurchaseItem[]
  accounts_payable   AccountsPayable[]
  creator            User              @relation(fields: [created_by], references: [id])
  Import             Import[]

  @@map("purchases")
}

model PurchaseItem {
  id               String   @id @default(cuid())
  purchase_id      String
  product_id       String?
  product_name     String
  quantity         Int
  unit_price       Float
  total_price      Float
  dutiable_value   Float?
  tariff_code      String?
  import_duty_rate Float?
  alc_percentage   Float?
  volume_ml        Int?
  weight_kg        Float?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
  product          Product? @relation(fields: [product_id], references: [id])
  purchase         Purchase @relation(fields: [purchase_id], references: [id], onDelete: Cascade)

  @@map("purchase_items")
}

model GoodsReceipt {
  id                String           @id @default(cuid())
  purchase_id       String
  actual_quantity   Int
  exchange_rate     Float
  loss_type         String
  loss_quantity     Int              @default(0)
  inspection_fee    Float?
  allocation_method String
  total_cost        Float
  created_at        DateTime         @default(now())
  updated_at        DateTime         @updatedAt
  additional_costs  AdditionalCost[]
  purchase          Purchase         @relation(fields: [purchase_id], references: [id], onDelete: Cascade)

  @@map("goods_receipts")
}

model AdditionalCost {
  id               String       @id @default(cuid())
  goods_receipt_id String
  type             String
  amount           Float
  description      String?
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt
  goods_receipt    GoodsReceipt @relation(fields: [goods_receipt_id], references: [id], onDelete: Cascade)

  @@map("additional_costs")
}

model Sale {
  id                   String               @id @default(cuid())
  sale_number          String               @unique
  customer_id          String
  total_amount         Float
  actual_amount        Float?
  commission           Float?
  funding_source       String
  payment_terms        PaymentTerms         @default(CASH)
  is_paid              Boolean              @default(false)
  paid_at              DateTime?
  due_date             DateTime?
  notes                String?
  created_by           String
  created_at           DateTime             @default(now())
  updated_at           DateTime             @updatedAt
  confirmed_at         DateTime?
  confirmed_by         String?
  status               SaleStatus           @default(DRAFT)
  accounts_receivables AccountsReceivable[]
  items                SaleItem[]
  creator              User                 @relation(fields: [created_by], references: [id])
  customer             Customer             @relation(fields: [customer_id], references: [id])
  shipping_orders      ShippingOrder[]

  @@map("sales")
}

model SaleItem {
  id                   String  @id @default(cuid())
  sale_id              String
  product_id           String
  variant_id           String?
  quantity             Int
  unit_price           Float
  actual_unit_price    Float?
  total_price          Float
  actual_total_price   Float?
  is_personal_purchase Boolean @default(false)

  // ğŸ¯ æˆæœ¬èˆ‡åˆ©æ½¤è¿½è¹¤
  cost_price Float? // éŠ·å”®æ™‚çš„åŠ æ¬Šå¹³å‡æˆæœ¬
  profit     Float? // åˆ©æ½¤ = actual_unit_price - cost_price
  import_id  String? // é—œè¯é€²è²¨å–®ï¼ˆç”¨æ–¼æˆæœ¬å›æº¯èª¿æ•´ï¼‰

  created_at     DateTime        @default(now())
  updated_at     DateTime        @updatedAt
  product        Product         @relation(fields: [product_id], references: [id])
  sale           Sale            @relation(fields: [sale_id], references: [id], onDelete: Cascade)
  variant        ProductVariant? @relation(fields: [variant_id], references: [id])
  import         Import?         @relation(fields: [import_id], references: [id], onDelete: SetNull)
  shipping_items ShippingItem[]

  @@index([import_id])
  @@map("sale_items")
}

model AccountingEntry {
  id              String         @id @default(cuid())
  entry_number    String         @unique
  entry_date      DateTime
  entry_type      String
  reference_id    String?
  reference_type  String?
  description     String
  total_amount    Float
  is_posted       Boolean        @default(false)
  notes           String?
  created_by      String
  created_at      DateTime       @default(now())
  updated_at      DateTime       @updatedAt
  creator         User           @relation(fields: [created_by], references: [id])
  journal_entries JournalEntry[]

  @@map("accounting_entries")
}

model JournalEntry {
  id                  String          @id @default(cuid())
  accounting_entry_id String
  account_code        String
  account_name        String
  debit_amount        Float           @default(0)
  credit_amount       Float           @default(0)
  description         String?
  created_at          DateTime        @default(now())
  accounting_entry    AccountingEntry @relation(fields: [accounting_entry_id], references: [id], onDelete: Cascade)

  @@map("journal_entries")
}

model AccountsReceivable {
  id               String          @id @default(cuid())
  ar_number        String          @unique
  customer_id      String
  sale_id          String
  original_amount  Float
  remaining_amount Float
  due_date         DateTime
  status           String          @default("OUTSTANDING")
  days_past_due    Int             @default(0)
  notes            String?
  created_by       String
  created_at       DateTime        @default(now())
  updated_at       DateTime        @updatedAt
  creator          User            @relation(fields: [created_by], references: [id])
  customer         Customer        @relation(fields: [customer_id], references: [id])
  sale             Sale            @relation(fields: [sale_id], references: [id])
  payments         PaymentRecord[]

  @@map("accounts_receivable")
}

model PaymentRecord {
  id                     String             @id @default(cuid())
  payment_number         String             @unique
  accounts_receivable_id String
  payment_amount         Float
  payment_date           DateTime
  payment_method         String
  reference_number       String?
  notes                  String?
  created_by             String
  created_at             DateTime           @default(now())
  accounts_receivable    AccountsReceivable @relation(fields: [accounts_receivable_id], references: [id])
  creator                User               @relation(fields: [created_by], references: [id])

  @@map("payment_records")
}

// æ‡‰ä»˜å¸³æ¬¾è¡¨ - æˆ‘å€‘æ¬ ä¾›æ‡‰å•†çš„éŒ¢
model AccountsPayable {
  id               String            @id @default(cuid())
  ap_number        String            @unique
  purchase_id      String?
  supplier_name    String
  original_amount  Float
  remaining_amount Float
  due_date         DateTime
  status           String            @default("PENDING") // PENDING, OVERDUE, PAID, PARTIAL
  days_past_due    Int               @default(0)
  ap_category      ApCategory        @default(PURCHASE)
  reference        String?
  notes            String?
  created_by       String
  created_at       DateTime          @default(now())
  updated_at       DateTime          @updatedAt
  creator          User              @relation(fields: [created_by], references: [id])
  purchase         Purchase?         @relation(fields: [purchase_id], references: [id])
  payments         SupplierPayment[]

  @@map("accounts_payable")
}

// ä¾›æ‡‰å•†ä»˜æ¬¾è¨˜éŒ„
model SupplierPayment {
  id                  String          @id @default(cuid())
  payment_number      String          @unique
  accounts_payable_id String
  payment_amount      Float
  payment_date        DateTime
  payment_method      String // CASH, BANK_TRANSFER, CHECK, CREDIT_CARD, OTHER
  reference_number    String?
  notes               String?
  created_by          String
  created_at          DateTime        @default(now())
  accounts_payable    AccountsPayable @relation(fields: [accounts_payable_id], references: [id])
  creator             User            @relation(fields: [created_by], references: [id])

  @@map("supplier_payments")
}

model Quotation {
  id            String          @id @default(cuid())
  quote_number  String          @unique
  customer_id   String
  product_id    String?
  product_name  String
  quantity      Int
  unit_price    Float
  total_amount  Float
  special_notes String?
  status        QuotationStatus @default(PENDING)
  valid_until   DateTime?
  quoted_by     String
  source        String          @default("WEB")
  line_user_id  String?
  created_at    DateTime        @default(now())
  updated_at    DateTime        @updatedAt
  customer      Customer        @relation(fields: [customer_id], references: [id])
  product       Product?        @relation(fields: [product_id], references: [id])
  quoter        User            @relation(fields: [quoted_by], references: [id])

  @@map("quotations")
}

model ShippingOrder {
  id               String         @id @default(cuid())
  shipping_number  String         @unique
  sale_id          String
  customer_id      String
  shipping_address String
  shipping_method  String         @default("DELIVERY")
  tracking_number  String?
  status           String         @default("PENDING")
  shipped_at       DateTime?
  delivered_at     DateTime?
  notes            String?
  created_at       DateTime       @default(now())
  updated_at       DateTime       @updatedAt
  items            ShippingItem[]
  customer         Customer       @relation(fields: [customer_id], references: [id])
  sale             Sale           @relation(fields: [sale_id], references: [id])

  @@map("shipping_orders")
}

model ShippingItem {
  id                String          @id @default(cuid())
  shipping_order_id String
  sale_item_id      String
  product_id        String
  variant_id        String?
  quantity          Int
  unit_price        Float
  total_price       Float
  created_at        DateTime        @default(now())
  product           Product         @relation(fields: [product_id], references: [id])
  sale_item         SaleItem        @relation(fields: [sale_item_id], references: [id])
  shipping_order    ShippingOrder   @relation(fields: [shipping_order_id], references: [id], onDelete: Cascade)
  variant           ProductVariant? @relation(fields: [variant_id], references: [id])

  @@map("shipping_items")
}

// âš ï¸ èˆŠç‰ˆé€²è²¨è¨˜éŒ„ - ä¿ç•™ç”¨æ–¼è³‡æ–™é·ç§»
model LegacyImportRecord {
  id                  String             @id @default(cuid())
  import_number       String             @unique
  purchase_id         String
  purchase_number     String
  supplier            String
  declaration_number  String?
  declaration_date    DateTime?
  total_value         Float
  currency            String             @default("TWD")
  exchange_rate       Float              @default(1.0)
  status              String             @default("PENDING")
  alcohol_tax         Float              @default(0)
  business_tax        Float              @default(0)
  trade_promotion_fee Float              @default(0)
  total_taxes         Float              @default(0)
  extracted_data      String?
  notes               String?
  created_at          DateTime           @default(now())
  updated_at          DateTime           @updatedAt
  items               LegacyImportItem[]

  @@map("import_records")
}

// âš ï¸ èˆŠç‰ˆé€²è²¨æ˜ç´° - ä¿ç•™ç”¨æ–¼è³‡æ–™é·ç§»
model LegacyImportItem {
  id                 String             @id @default(cuid())
  import_record_id   String
  product_name       String
  quantity           Int
  alcohol_percentage Float              @default(40)
  volume             Int                @default(700)
  dutiable_value     Float
  alcohol_tax        Float              @default(0)
  business_tax       Float              @default(0)
  tariff_code        String?
  created_at         DateTime           @default(now())
  updated_at         DateTime           @updatedAt
  import_record      LegacyImportRecord @relation(fields: [import_record_id], references: [id], onDelete: Cascade)

  @@map("import_items")
}

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("system_settings")
}

enum Role {
  SUPER_ADMIN
  INVESTOR
  EMPLOYEE
  PENDING
}

enum PaymentTerms {
  CASH
  WEEKLY
  MONTHLY
  SIXTY_DAYS
}

enum SaleStatus {
  DRAFT
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum AlcoholCategory {
  WHISKY
  WINE
  SAKE
  BEER
  SPIRITS
  LIQUEUR
  OTHER
}

enum CustomerTier {
  VIP
  REGULAR
  PREMIUM
  NEW
}

enum QuotationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

// å¯©è¨ˆæ—¥èªŒæ¨¡å‹
model AuditLog {
  id              String            @id @default(cuid())
  user_id         String
  user_email      String
  user_role       Role
  action          AuditAction
  resource_type   AuditResourceType
  resource_id     String?
  details         Json?
  ip_address      String?
  user_agent      String?
  additional_info Json?
  created_at      DateTime          @default(now())

  @@index([user_id])
  @@index([created_at])
  @@index([action])
  @@index([resource_type])
  @@map("audit_logs")
}

// å¯©è¨ˆæ“ä½œé¡å‹
enum AuditAction {
  READ
  WRITE
  DELETE
  LOGIN
  LOGOUT
  PERMISSION_CHANGE
  DATA_FILTERING
  SENSITIVE_ACCESS
}

// è³‡æºé¡å‹
enum ResourceType {
  USERS
  CUSTOMERS
  PRODUCTS
  SALES
  PURCHASES
  INVENTORY
  SETTINGS
  REPORTS
  LINEBOT
}

// å¯©è¨ˆè³‡æºé¡å‹
enum AuditResourceType {
  USERS
  CUSTOMERS
  PRODUCTS
  SALES
  PURCHASES
  INVENTORY
  SETTINGS
  REPORTS
  LINEBOT
  CASHFLOW
}

// ğŸ’° ç°¡å–®æ”¶æ”¯è¨˜éŒ„æ¨¡å‹
model CashFlowRecord {
  id               String        @id @default(cuid())
  type             CashFlowType // æ”¶å…¥æˆ–æ”¯å‡º
  amount           Float // é‡‘é¡
  description      String // æè¿°
  category         String? // åˆ†é¡ï¼ˆå¯é¸ï¼‰
  funding_source   FundingSource // è³‡é‡‘ä¾†æºï¼šæŠ•è³‡æ–¹æˆ–å€‹äººå¢Šä»˜
  transaction_date DateTime // äº¤æ˜“æ—¥æœŸ
  reference        String? // åƒè€ƒç·¨è™Ÿï¼ˆç™¼ç¥¨è™Ÿç¢¼ã€è¨‚å–®ç·¨è™Ÿç­‰ï¼‰
  notes            String? // å‚™è¨»
  created_by       String // è¨˜éŒ„å‰µå»ºè€…
  created_at       DateTime      @default(now())
  updated_at       DateTime      @updatedAt

  // é—œè¯
  creator User @relation(fields: [created_by], references: [id])

  @@index([type])
  @@index([funding_source])
  @@index([transaction_date])
  @@index([created_by])
  @@map("cashflow_records")
}

// å…¬å¸è¨­å®šè¡¨
model CompanySettings {
  id           String   @id @default(cuid())
  name         String // å…¬å¸åç¨±
  englishName  String? // è‹±æ–‡åç¨±
  address      String // å…¬å¸åœ°å€
  phone        String // è¯çµ¡é›»è©±
  email        String? // é›»å­ä¿¡ç®±
  website      String? // å®˜æ–¹ç¶²ç«™
  taxId        String // çµ±ä¸€ç·¨è™Ÿ
  bankName     String? // éŠ€è¡Œåç¨±
  bankAccount  String? // å¸³æˆ¶è™Ÿç¢¼
  bankCode     String? // éŠ€è¡Œä»£ç¢¼
  // ç¾ä»£è¯çµ¡æ–¹å¼
  lineId       String? // LINE ID
  customField1 String? // è‡ªè¨‚æ¬„ä½1 (å¦‚ WeChat ID)
  customField2 String? // è‡ªè¨‚æ¬„ä½2 (å¦‚ Telegram)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@map("company_settings")
}

// æ”¶æ”¯é¡å‹
enum CashFlowType {
  INCOME // æ”¶å…¥
  EXPENSE // æ”¯å‡º
}

// è³‡é‡‘ä¾†æº
enum FundingSource {
  INVESTOR // æŠ•è³‡æ–¹è³‡é‡‘
  PERSONAL // å€‹äººå¢Šä»˜
  COMPANY // å…¬å¸è³‡é‡‘
}

// ========== ğŸ†• é‡æ§‹æ–°å¢çš„æ¨¡å‹ (2025-10-01) ==========

// ğŸª å€‰åº«é¡å‹
enum Warehouse {
  COMPANY // å…¬å¸å€‰ï¼ˆæŠ•è³‡æ–¹è³‡é‡‘ï¼‰
  PRIVATE // å€‹äººå€‰ï¼ˆå€‹äººè³‡é‡‘ï¼‰
}

// ğŸ“¦ å“è™Ÿèª¿æ’¥è¨˜éŒ„
model StockTransfer {
  id              String @id @default(cuid())
  transfer_number String @unique

  // ä¾†æºè®Šé«”
  source_variant_id   String
  source_variant_code String

  // ç›®æ¨™è®Šé«”
  target_variant_id   String
  target_variant_code String

  // èª¿æ’¥æ•¸é‡
  quantity Int

  // æˆæœ¬ç¹¼æ‰¿
  unit_cost  Float
  total_cost Float

  // èª¿æ’¥åŸå› 
  reason String // 'DAMAGED', 'REPACKAGE', 'OTHER'
  notes  String?

  // å¯©è¨ˆæ¬„ä½
  created_by String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // é—œè¯
  source_variant ProductVariant @relation("SourceVariant", fields: [source_variant_id], references: [id], onDelete: Restrict)
  target_variant ProductVariant @relation("TargetVariant", fields: [target_variant_id], references: [id], onDelete: Restrict)
  creator        User           @relation(fields: [created_by], references: [id])

  @@index([source_variant_id])
  @@index([target_variant_id])
  @@index([created_at])
  @@map("stock_transfers")
}

// ğŸšš é€²è²¨å–®ï¼ˆé‡æ–°è¨­è¨ˆï¼‰
model Import {
  id            String @id @default(cuid())
  import_number String @unique

  // é—œè¯æ¡è³¼å–®
  purchase_id     String?
  purchase_number String?

  // é€²è²¨é¡å‹
  import_type String    @default("COMPANY") // 'COMPANY', 'PRIVATE'
  warehouse   Warehouse @default(COMPANY)

  // ä¾›æ‡‰å•†è³‡è¨Š
  supplier String

  // å¹£åˆ¥èˆ‡åŒ¯ç‡
  currency      String @default("JPY")
  exchange_rate Float  @default(1.0)

  // å ±é—œè³‡è¨Š
  declaration_number String?
  declaration_date   DateTime?
  customs_date       DateTime?

  // æµ·é—œæŠ½é©—
  customs_seized  Boolean @default(false)
  seized_quantity Int     @default(0)

  // å•†å“ç¸½åƒ¹ï¼ˆæœªç¨…ï¼‰
  goods_total Float

  // é—œç¨…ï¼ˆå€‹åˆ¥è¨ˆç®—ï¼‰
  tariff_amount Float @default(0)

  // è²»ç”¨ç¸½é¡ï¼ˆå¾…å¾ŒçºŒåŠ å…¥ï¼‰
  additional_costs_total Float @default(0)

  // æœ€çµ‚ç¸½æˆæœ¬
  final_total_cost Float @default(0)

  // çµç®—ç‹€æ…‹
  is_finalized Boolean   @default(false)
  finalized_at DateTime?
  finalized_by String?

  // é€²è²¨ç‹€æ…‹
  status String @default("PENDING") // 'PENDING', 'IN_TRANSIT', 'CUSTOMS', 'RECEIVED', 'FINALIZED'

  // å‚™è¨»
  notes String?

  // å¯©è¨ˆæ¬„ä½
  created_by String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // é—œè¯
  purchase             Purchase?           @relation(fields: [purchase_id], references: [id], onDelete: SetNull)
  creator              User                @relation("ImportCreator", fields: [created_by], references: [id])
  finalizer            User?               @relation("ImportFinalizer", fields: [finalized_by], references: [id])
  items                ImportItem[]
  costs                ImportCost[]
  cost_adjustment_logs CostAdjustmentLog[]
  sale_items           SaleItem[]

  @@index([purchase_id])
  @@index([warehouse])
  @@index([status])
  @@index([created_at])
  @@map("imports")
}

// ğŸ“‹ é€²è²¨æ˜ç´°ï¼ˆæ–°ç‰ˆï¼‰
model ImportItem {
  id        String @id @default(cuid())
  import_id String

  // å•†å“è³‡è¨Š
  variant_id   String
  variant_code String
  product_name String

  // æ•¸é‡
  ordered_quantity  Int
  received_quantity Int
  damaged_quantity  Int @default(0)

  // å–®åƒ¹èˆ‡å°è¨ˆ
  unit_price Float
  subtotal   Float

  // é—œç¨…ï¼ˆå€‹åˆ¥å•†å“ï¼‰
  tariff_rate   Float?
  tariff_amount Float  @default(0)

  // åˆ†æ”¤å¾Œè²»ç”¨
  allocated_costs Float @default(0)

  // æœ€çµ‚å–®ä½æˆæœ¬
  final_unit_cost Float @default(0)

  // å¯©è¨ˆæ¬„ä½
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // é—œè¯
  import  Import         @relation(fields: [import_id], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [variant_id], references: [id], onDelete: Restrict)

  @@index([import_id])
  @@index([variant_id])
  @@map("import_items_v2")
}

// ğŸ’° é€²è²¨è²»ç”¨æ± 
model ImportCost {
  id        String @id @default(cuid())
  import_id String

  // è²»ç”¨é¡å‹
  cost_type String // 'INSPECTION', 'CUSTOMS_FEE', 'SHIPPING', 'STORAGE', 'OTHER'
  cost_name String

  // é‡‘é¡
  amount   Float
  currency String @default("TWD")

  // åˆ†æ”¤æ–¹å¼
  allocation_method String @default("BY_AMOUNT") // 'BY_AMOUNT', 'BY_QUANTITY', 'INDIVIDUAL'

  // ç™¼ç¥¨/å–®æ“šè³‡è¨Š
  invoice_number String?
  invoice_date   DateTime?

  // ä»˜æ¬¾ç‹€æ…‹
  is_paid Boolean   @default(false)
  paid_at DateTime?

  // å‚™è¨»
  notes String?

  // å¯©è¨ˆæ¬„ä½
  created_by String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // é—œè¯
  import  Import @relation(fields: [import_id], references: [id], onDelete: Cascade)
  creator User   @relation(fields: [created_by], references: [id])

  @@index([import_id])
  @@index([cost_type])
  @@index([is_paid])
  @@map("import_costs")
}

// ğŸ“Š æˆæœ¬èª¿æ•´æ­·å²
model CostAdjustmentLog {
  id        String @id @default(cuid())
  import_id String

  // èª¿æ•´è³‡è¨Š
  adjustment_type String // 'FINALIZE', 'MANUAL'
  old_cost        Float
  new_cost        Float
  cost_diff       Float

  // å½±éŸ¿ç¯„åœ
  affected_sales_count Int   @default(0)
  total_adjustment     Float @default(0)

  // èªªæ˜
  reason String?

  // å¯©è¨ˆæ¬„ä½
  created_by String
  created_at DateTime @default(now())

  // é—œè¯
  import  Import @relation(fields: [import_id], references: [id], onDelete: Cascade)
  creator User   @relation(fields: [created_by], references: [id])

  @@index([import_id])
  @@index([created_at])
  @@map("cost_adjustment_logs")
}

// ğŸ”” é€šçŸ¥ç³»çµ±
model Notification {
  id String @id @default(cuid())

  // é€šçŸ¥é¡å‹
  type String // 'IMPORT_FINALIZED', 'STOCK_LOW', 'PAYMENT_DUE', 'SHIPMENT_REMINDER', 'PRICE_ALERT'

  // é€šçŸ¥å…§å®¹
  title   String
  message String
  link    String?

  // æ¥æ”¶è€…
  recipient_id   String
  recipient_role Role?

  // å„ªå…ˆç´š
  priority String @default("NORMAL") // 'LOW', 'NORMAL', 'HIGH', 'URGENT'

  // é–±è®€ç‹€æ…‹
  is_read Boolean   @default(false)
  read_at DateTime?

  // ç›¸é—œè³‡æº
  resource_type String?
  resource_id   String?

  // å¯©è¨ˆæ¬„ä½
  created_at DateTime  @default(now())
  expires_at DateTime?

  // é—œè¯
  recipient User @relation(fields: [recipient_id], references: [id], onDelete: Cascade)

  @@index([recipient_id])
  @@index([is_read])
  @@index([created_at])
  @@index([type])
  @@map("notifications")
}
