// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  INVESTOR
  EMPLOYEE
}

enum PaymentTerms {
  CASH
  WEEKLY
  MONTHLY
  SIXTY_DAYS
}

enum AlcoholCategory {
  WHISKY
  WINE
  SAKE
  BEER
  SPIRITS
  LIQUEUR
  OTHER
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String
  image       String?
  role        Role     @default(EMPLOYEE)
  investorId  String?  // æŠ•è³‡æ–¹é—œè¯ID
  isActive    Boolean  @default(true)
  preferences Json?    // å€‹äººåå¥½è¨­å®š
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // é—œè¯è¡¨
  createdPurchases        Purchase[]
  createdSales           Sale[]
  createdAccountingEntries AccountingEntry[]
  createdAccountsReceivable AccountsReceivable[]
  createdPaymentRecords   PaymentRecord[]

  @@map("users")
}

enum CustomerTier {
  VIP
  REGULAR
  PREMIUM
  NEW
}

model Customer {
  id              String       @id @default(cuid())
  customer_code   String       @unique // C00001, C00002 ç­‰
  name            String
  contact_person  String?      // ä¸»è¦è¯çµ¡äºº
  phone           String?
  email           String?
  company         String?      // å…¬å¸åç¨±
  tax_id          String?      // çµ±ä¸€ç·¨è™Ÿ
  address         String?      // è¯çµ¡åœ°å€
  shipping_address String?     // é€è²¨åœ°å€
  tier            CustomerTier @default(REGULAR)
  paymentTerms    PaymentTerms @default(CASH)
  requiresInvoice Boolean      @default(false)
  credit_limit    Float?       // ä¿¡ç”¨é¡åº¦
  notes           String?
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // é—œè¯è¡¨
  sales Sale[]
  specialPrices CustomerSpecialPrice[]

  @@map("customers")
}

model Product {
  id               String           @id @default(cuid())
  product_code     String           @unique // P00001, P00002 ç­‰
  code             String           @unique // ä¿ç•™å‘å¾Œç›¸å®¹æ€§
  name             String
  category         AlcoholCategory
  volume_ml        Int              // å®¹é‡(ml) - çµ±ä¸€å‘½åè¦ç¯„
  alc_percentage   Float            // é…’ç²¾åº¦(%) - çµ±ä¸€å‘½åè¦ç¯„
  weight           Float            // å•†å“é‡é‡(kg)
  packageWeight    Float?           // å¤–ç›’é‡é‡(kg)
  totalWeight      Float?           // ç¸½é‡é‡(kg)
  hasBox           Boolean          @default(false)
  hasAccessories   Boolean          @default(false)
  accessoryWeight  Float?           // é™„ä»¶é‡é‡(kg)
  accessories      String[]         // é™„ä»¶æ¸…å–®
  hsCode           String?          // ç¨…å‰‡è™Ÿåˆ—
  supplier         String?
  manufacturingDate String?
  expiryDate       String?
  standardPrice    Float            // æ¨™æº–å”®åƒ¹
  currentPrice     Float            // ç›®å‰å”®åƒ¹
  costPrice        Float            @default(0) // å¹³å‡æˆæœ¬åƒ¹
  minPrice         Float            // æœ€ä½å”®åƒ¹é™åˆ¶
  totalStock       Int              @default(0) // ç¸½åº«å­˜
  availableStock   Int              @default(0) // å¯å”®åº«å­˜
  reservedStock    Int              @default(0) // é ç•™åº«å­˜
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // é—œè¯è¡¨
  variants         ProductVariant[]
  purchaseItems    PurchaseItem[]
  saleItems        SaleItem[]
  specialPrices    CustomerSpecialPrice[]

  @@map("products")
}

enum VariantType {
  A  // ä¸€èˆ¬ç‰ˆ
  B  // å¹´åº¦é™å®šç‰ˆ
  C  // ç´€å¿µç‰ˆ
  D  // ç‰¹æ®Šé™å®šç‰ˆ
  X  // æå‚·å“
}

model ProductVariant {
  id              String      @id @default(cuid())
  productId       String
  variant_code    String      @unique // P00001-A, P00001-C, P00001-X
  variantType     VariantType // A, B, C, D, X
  description     String      // "ä¸€èˆ¬ç‰ˆ", "100å‘¨å¹´ç´€å¿µç‰ˆ", "æå‚·å“"
  basePrice       Float       // åŸºç¤å”®åƒ¹
  currentPrice    Float       // ç›®å‰å”®åƒ¹
  discountRate    Float?      // æŠ˜æ‰£ç‡ (æå‚·å“ç”¨)
  limitedEdition  Boolean     @default(false)
  productionYear  Int?
  serialNumber    String?
  condition       String      @default("æ­£å¸¸") // å•†å“ç‹€æ³
  stock_quantity    Int         @default(0)    // ç¸½åº«å­˜
  reserved_stock    Int         @default(0)    // é ç•™åº«å­˜
  available_stock   Int         @default(0)    // å¯å”®åº«å­˜
  cost_price        Float       @default(0)    // å¯¦éš›æˆæœ¬
  weight_kg         Float       @default(0)    // å•†å“é‡é‡(kg) - éµå¾ªDATA_MODELS.mdè¦ç¯„
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // é—œè¯
  product            Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  saleItems          SaleItem[]
  inventoryMovements InventoryMovement[]

  @@unique([productId, variantType])
  @@map("product_variants")
}

model CustomerSpecialPrice {
  id              String   @id @default(cuid())
  customer_id     String
  product_id      String
  standard_price  Float    // æ¨™æº–åƒ¹æ ¼
  special_price   Float    // å°ˆå±¬åƒ¹æ ¼
  discount_amount Float    // æŠ˜æ‰£é‡‘é¡
  discount_rate   Float    // æŠ˜æ‰£ç‡
  reason          String   // èª¿åƒ¹åŸå› 
  effective_date  DateTime // ç”Ÿæ•ˆæ—¥æœŸ
  expiry_date     DateTime? // åˆ°æœŸæ—¥æœŸ
  is_active       Boolean  @default(true)
  notes           String?
  created_by      String   // å»ºç«‹è€…
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // é—œè¯
  customer Customer @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([customer_id, product_id])
  @@map("customer_special_prices")
}

model InventoryMovement {
  id              String   @id @default(cuid())
  variantId       String
  movementType    String   // 'PURCHASE' | 'SALE' | 'ADJUSTMENT' | 'TRANSFER'
  adjustmentType  String?  // 'ADD' | 'SUBTRACT' | 'SET' (åªæœ‰ADJUSTMENTæ™‚ä½¿ç”¨)
  quantity        Int      // ç•°å‹•æ•¸é‡
  previousStock   Int      // ç•°å‹•å‰åº«å­˜
  newStock        Int      // ç•°å‹•å¾Œåº«å­˜
  reason          String   // ç•°å‹•åŸå› 
  notes           String?  // å‚™è¨»
  referenceId     String?  // é—œè¯å–®æ“šID (æ¡è³¼å–®ã€éŠ·å”®å–®ç­‰)
  referenceType   String?  // é—œè¯å–®æ“šé¡å‹
  createdBy       String   // æ“ä½œè€…
  created_at      DateTime @default(now())

  // é—œè¯
  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("inventory_movements")
}

model Purchase {
  id            String         @id @default(cuid())
  purchaseNumber String        @unique // PO20250917001
  fundingSource String         // 'COMPANY' | 'PERSONAL'
  supplier      String
  currency      String         @default("JPY")
  exchangeRate  Float
  totalAmount   Float
  status        String         @default("PENDING") // PENDING, RECEIVED, COMPLETED
  declarationNumber String?    // å ±å–®è™Ÿç¢¼
  declarationDate   DateTime?  // å ±é—œæ—¥æœŸ
  receivedDate      DateTime?  // åˆ°è²¨æ—¥æœŸ
  notes         String?
  createdBy     String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // é—œè¯
  creator   User           @relation(fields: [createdBy], references: [id])
  items     PurchaseItem[]
  receipts  GoodsReceipt[]

  @@map("purchases")
}

model PurchaseItem {
  id                String   @id @default(cuid())
  purchaseId        String
  productId         String?  // å¯èƒ½æ˜¯æ–°å•†å“
  productName       String
  quantity          Int
  unitPrice         Float
  totalPrice        Float
  dutiableValue     Float?   // å®Œç¨…åƒ¹æ ¼
  tariffCode        String?  // ç¨…å‰‡è™Ÿåˆ—
  importDutyRate    Float?   // é€²å£ç¨…ç‡
  alc_percentage    Float?   // é…’ç²¾åº¦ - çµ±ä¸€å‘½åè¦ç¯„
  volume_ml         Int?     // å®¹é‡ - çµ±ä¸€å‘½åè¦ç¯„
  weightKg          Float?   // é‡é‡
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // é—œè¯
  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product  Product? @relation(fields: [productId], references: [id])

  @@map("purchase_items")
}

model GoodsReceipt {
  id               String  @id @default(cuid())
  purchaseId       String
  actualQuantity   Int     // å¯¦éš›åˆ°è²¨æ•¸é‡
  exchangeRate     Float   // å¯¦éš›åŒ¯ç‡
  lossType         String  // 'NONE' | 'INSPECTION' | 'RADIATION' | 'DAMAGE'
  lossQuantity     Int     @default(0) // æå¤±æ•¸é‡
  inspectionFee    Float?  // æŠ½é©—è²»
  allocationMethod String  // 'VALUE' | 'QUANTITY' | 'WEIGHT'
  totalCost        Float   // ç¸½æˆæœ¬
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // é—œè¯
  purchase         Purchase            @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  additionalCosts  AdditionalCost[]

  @@map("goods_receipts")
}

model AdditionalCost {
  id              String @id @default(cuid())
  goodsReceiptId  String
  type            String // 'SHIPPING' | 'INSPECTION' | 'DECLARATION' | 'PORT_SERVICE'
  amount          Float
  description     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // é—œè¯
  goodsReceipt GoodsReceipt @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)

  @@map("additional_costs")
}

model Sale {
  id              String       @id @default(cuid())
  saleNumber      String       @unique // SA20250917001
  customerId      String
  totalAmount     Float        // é¡¯ç¤ºé‡‘é¡ï¼ˆæŠ•è³‡æ–¹çœ‹åˆ°çš„ï¼‰
  actualAmount    Float?       // å¯¦éš›æ”¶å–é‡‘é¡ï¼ˆåƒ…è¶…ç´šç®¡ç†å“¡ï¼‰
  commission      Float?       // è€é—†å‚­é‡‘ï¼ˆåƒ…è¶…ç´šç®¡ç†å“¡ï¼‰
  fundingSource   String       // 'COMPANY' | 'PERSONAL'
  paymentTerms    PaymentTerms @default(CASH)
  isPaid          Boolean      @default(false)
  paidAt          DateTime?
  dueDate         DateTime?
  notes           String?
  createdBy       String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // é—œè¯
  customer Customer   @relation(fields: [customerId], references: [id])
  creator  User       @relation(fields: [createdBy], references: [id])
  items    SaleItem[]
  accountsReceivable AccountsReceivable[]

  @@map("sales")
}

model SaleItem {
  id                  String  @id @default(cuid())
  saleId              String
  productId           String
  variantId           String?
  quantity            Int
  unitPrice           Float   // é¡¯ç¤ºå–®åƒ¹
  actualUnitPrice     Float?  // å¯¦éš›å–®åƒ¹ï¼ˆåƒ…è¶…ç´šç®¡ç†å“¡ï¼‰
  totalPrice          Float   // é¡¯ç¤ºç¸½åƒ¹
  actualTotalPrice    Float?  // å¯¦éš›ç¸½åƒ¹ï¼ˆåƒ…è¶…ç´šç®¡ç†å“¡ï¼‰
  isPersonalPurchase  Boolean @default(false) // æ˜¯å¦ç‚ºå€‹äººèª¿è²¨
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // é—œè¯
  sale    Sale           @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@map("sale_items")
}

// å¯©è¨ˆæ—¥èªŒè¡¨ - è¨˜éŒ„æ•æ„Ÿè³‡æ–™å­˜å–
model AuditLog {
  id              String   @id @default(cuid())
  userId          String   // æ“ä½œä½¿ç”¨è€…ID
  userEmail       String   // ä½¿ç”¨è€…Email
  userRole        Role     // ä½¿ç”¨è€…è§’è‰²
  action          String   // æ“ä½œé¡å‹ (READ, CREATE, UPDATE, DELETE)
  tableName       String   // æ“ä½œçš„è¡¨æ ¼
  recordId        String?  // è¨˜éŒ„ID
  sensitiveFields Json?    // å­˜å–çš„æ•æ„Ÿæ¬„ä½
  ipAddress       String?  // IPä½å€
  userAgent       String?  // ç€è¦½å™¨è³‡è¨Š
  timestamp       DateTime @default(now())

  // å•†æ¥­æ•æ„Ÿè³‡æ–™å­˜å–è¨˜éŒ„
  accessedActualPrice   Boolean @default(false) // æ˜¯å¦å­˜å–çœŸå¯¦åƒ¹æ ¼
  accessedCommission    Boolean @default(false) // æ˜¯å¦å­˜å–å‚­é‡‘è³‡æ–™
  accessedPersonalData  Boolean @default(false) // æ˜¯å¦å­˜å–å€‹äººèª¿è²¨è³‡æ–™

  @@map("audit_logs")
}

// ğŸ§® æœƒè¨ˆç³»çµ±æ¨¡å‹ - Room-4 æ“´å±•

model AccountingEntry {
  id              String   @id @default(cuid())
  entryNumber     String   @unique // AE20250917001
  entryDate       DateTime // å…¥å¸³æ—¥æœŸ
  entryType       String   // 'SALE' | 'PURCHASE' | 'PAYMENT' | 'ADJUSTMENT'
  referenceId     String?  // é—œè¯å–®æ“šID (éŠ·å”®å–®ã€æ¡è³¼å–®ç­‰)
  referenceType   String?  // é—œè¯å–®æ“šé¡å‹
  description     String   // æ‘˜è¦èªªæ˜
  totalAmount     Float    // åˆè¨ˆé‡‘é¡
  isPosted        Boolean  @default(false) // æ˜¯å¦éå¸³
  notes           String?
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // é—œè¯
  creator         User              @relation(fields: [createdBy], references: [id])
  journalEntries  JournalEntry[]

  @@map("accounting_entries")
}

model JournalEntry {
  id                String   @id @default(cuid())
  accountingEntryId String
  accountCode       String   // æœƒç§‘ä»£ç¢¼ (1101, 4101 etc.)
  accountName       String   // æœƒç§‘åç¨± (ç¾é‡‘, éŠ·è²¨æ”¶å…¥ etc.)
  debitAmount       Float    @default(0) // å€Ÿæ–¹é‡‘é¡
  creditAmount      Float    @default(0) // è²¸æ–¹é‡‘é¡
  description       String?  // æ˜ç´°èªªæ˜
  createdAt         DateTime @default(now())

  // é—œè¯
  accountingEntry   AccountingEntry @relation(fields: [accountingEntryId], references: [id], onDelete: Cascade)

  @@map("journal_entries")
}

// æ‡‰æ”¶å¸³æ¬¾ç®¡ç†
model AccountsReceivable {
  id              String       @id @default(cuid())
  arNumber        String       @unique // AR20250917001
  customerId      String
  saleId          String       // é—œè¯éŠ·å”®å–®
  originalAmount  Float        // åŸå§‹æ‡‰æ”¶é‡‘é¡
  remainingAmount Float        // å‰©é¤˜æ‡‰æ”¶é‡‘é¡
  dueDate         DateTime     // åˆ°æœŸæ—¥
  status          String       @default("OUTSTANDING") // OUTSTANDING, OVERDUE, PAID, PARTIAL
  daysPastDue     Int          @default(0) // é€¾æœŸå¤©æ•¸
  notes           String?
  createdBy       String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // é—œè¯
  customer        Customer            @relation(fields: [customerId], references: [id])
  sale            Sale                @relation(fields: [saleId], references: [id])
  creator         User                @relation(fields: [createdBy], references: [id])
  payments        PaymentRecord[]

  @@map("accounts_receivable")
}

model PaymentRecord {
  id                     String   @id @default(cuid())
  paymentNumber          String   @unique // PMT20250917001
  accountsReceivableId   String
  paymentAmount          Float    // ä»˜æ¬¾é‡‘é¡
  paymentDate            DateTime // ä»˜æ¬¾æ—¥æœŸ
  paymentMethod          String   // 'CASH' | 'TRANSFER' | 'CHECK' | 'CREDIT_CARD'
  referenceNumber        String?  // æ”¯ç¥¨è™Ÿç¢¼ã€è½‰å¸³åºè™Ÿç­‰
  notes                  String?
  createdBy              String
  createdAt              DateTime @default(now())

  // é—œè¯
  accountsReceivable     AccountsReceivable @relation(fields: [accountsReceivableId], references: [id])
  creator                User               @relation(fields: [createdBy], references: [id])

  @@map("payment_records")
}