# 🏷️ 客戶分級報價系統設計

## 🎯 系統目標

建立一個**僅老闆可見**的客戶分級報價系統，支援：
- 🏷️ 商品公版報價設定
- 👥 客戶專屬報價管理
- 📊 報價導出功能
- 📈 價格分析與追蹤

**重要**: 這是老闆的商業機密功能，投資方和員工都無法存取！

---

## 🏗️ **系統架構設計**

### **核心概念**
```
商品 W001 山崎18年威士忌
├── 📋 公版報價: $21,000 (新客戶/預設價格)
├── 👤 A客戶專價: $20,000 (VIP客戶優惠)
├── 👤 C客戶專價: $23,000 (容易亂賣，提高價格)
└── 📊 價格歷史記錄
```

### **客戶分級系統**
```typescript
enum CustomerTier {
  VIP = 'VIP',           // VIP客戶 (最優惠價格)
  REGULAR = 'REGULAR',   // 一般客戶 (標準價格)
  PREMIUM = 'PREMIUM',   // 高價客戶 (較高價格)
  NEW = 'NEW'           // 新客戶 (公版價格)
}
```

---

## 💻 **系統介面設計**

### **商品價格管理頁面**
```
┌─ 山崎18年威士忌 (W001) - 價格管理 ─┐
│
│ 📋 基本定價資訊
│ ├─ 成本價格: $8,000 (自動計算)
│ ├─ 公版報價: [21,000] 💡 建議: $18,000-25,000
│ ├─ 最低限價: $8,500 (成本+6%)
│ └─ 目前庫存: 15瓶
│
│ 👥 客戶專屬報價 (僅您可見)
│ ┌─────────────────────────────────┐
│ │ 客戶名稱  │ 分級 │ 專屬價格 │ 折扣 │ 最後更新 │ 操作 │
│ ├─────────────────────────────────┤
│ │ A客戶     │ VIP  │ $20,000 │ -5% │ 09/15   │ ✏️❌│
│ │ C客戶     │ PREM │ $23,000 │ +10%│ 09/10   │ ✏️❌│
│ │ 王小姐    │ REG  │ 使用公版 │ 0%  │ -       │ ➕  │
│ └─────────────────────────────────┘
│
│ 🔧 快速操作
│ [➕ 新增客戶專價] [📊 價格分析] [📤 導出報價表]
│
│ 📈 價格歷史
│ ├─ 2025/09/15: 公版 $21,000 → $21,000 (維持)
│ ├─ 2025/09/10: A客戶 $19,000 → $20,000 (調漲)
│ └─ 2025/09/05: C客戶 $22,000 → $23,000 (再次調漲)
└─────────────────────────────────────┘
```

### **新增/編輯客戶專價**
```
┌─ 設定客戶專屬價格 ─┐
│
│ 客戶選擇: [A客戶 ▼]
│ 客戶分級: [VIP ▼]
│
│ 價格設定:
│ ├─ 公版價格: $21,000
│ ├─ 專屬價格: [20,000]
│ ├─ 折扣金額: $1,000 (-4.8%)
│ └─ 毛利分析: 成本$8,000 → 毛利$12,000 (60%)
│
│ 調價原因: [VIP客戶長期合作優惠        ]
│ 生效日期: [2025/09/15]
│ 有效期限: [永久 ▼] / 指定日期
│
│ 📝 備註:
│ [A客戶是長期合作夥伴，給予優惠價格以維持關係]
│
│ [💾 儲存] [❌ 取消]
└─────────────────────┘
```

---

## 📤 **報價導出功能**

### **報價單生成**
```
┌─ 生成客戶報價單 ─┐
│
│ 📋 基本資訊
│ ├─ 客戶: [A客戶 ▼]
│ ├─ 報價日期: [2025/09/15]
│ ├─ 有效期限: [2025/10/15] (30天)
│ └─ 報價單號: QT20250915001 (自動生成)
│
│ 🍶 商品選擇
│ ┌─────────────────────────────┐
│ │ ☑️ W001 山崎18年威士忌 │ $20,000 │ VIP專價 │
│ │ ☑️ W025 山崎12年威士忌 │ $7,000  │ 公版價  │
│ │ ☐ W035 響21年威士忌   │ $35,000 │ 公版價  │
│ └─────────────────────────────┘
│
│ 🎨 報價單樣式
│ ├─ 📄 標準版 (簡潔實用)
│ ├─ 🎭 精美版 (包含商品圖片)
│ └─ 📊 詳細版 (含規格說明)
│
│ 💬 備註說明
│ [此報價為VIP客戶專屬優惠，請於期限內確認]
│
│ [📤 生成PDF] [📧 Email寄送] [💾 儲存草稿]
└─────────────────────────────────┘
```

### **導出格式範例**
```
════════════════════════════════════════
         🍶 酒類專業進口商 報價單
════════════════════════════════════════

報價單號: QT20250915001
客戶名稱: A客戶 (VIP)
報價日期: 2025年9月15日
有效期限: 2025年10月15日

────────────────────────────────────────
商品明細:
────────────────────────────────────────
1. 山崎18年威士忌 (W001)
   規格: 700ml, 43%
   數量: 1瓶
   單價: NT$ 20,000 ⭐VIP特價
   小計: NT$ 20,000

2. 山崎12年威士忌 (W025)
   規格: 700ml, 43%
   數量: 1瓶
   單價: NT$ 7,000
   小計: NT$ 7,000

────────────────────────────────────────
總計: NT$ 27,000
────────────────────────────────────────

💎 VIP客戶專享優惠已套用
📞 聯絡方式: [老闆電話]
📧 Email: [老闆Email]

本報價單有效期限至2025年10月15日，
過期後價格可能調整，請把握優惠機會！
════════════════════════════════════════
```

---

## 🔒 **權限控制設計**

### **嚴格權限限制**
```typescript
// 只有超級管理員(老闆)可以存取
const CUSTOMER_PRICING_PERMISSIONS = {
  view: ['SUPER_ADMIN'],
  create: ['SUPER_ADMIN'],
  update: ['SUPER_ADMIN'],
  delete: ['SUPER_ADMIN'],
  export: ['SUPER_ADMIN']
};

// 投資方和員工完全看不到這些功能
// - 客戶專屬價格
// - 價格歷史記錄
// - 報價導出功能
// - 客戶分級資訊
```

### **API安全檢查**
```typescript
// 每個相關API都要檢查
function requireSuperAdmin(req: NextApiRequest) {
  const user = getCurrentUser(req);
  if (user.role !== 'SUPER_ADMIN') {
    throw new Error('權限不足：此功能僅限超級管理員使用');
  }
}

// 範例：獲取客戶專價
app.get('/api/products/:id/customer-pricing', requireSuperAdmin, (req, res) => {
  // 只有老闆能看到客戶專價
});
```

---

## 📊 **價格分析功能**

### **客戶價格分析報表**
```
┌─ A客戶 - 價格分析報表 ─┐
│
│ 👤 客戶資訊
│ ├─ 客戶等級: VIP
│ ├─ 合作時間: 2年3個月
│ ├─ 總交易額: $450,000
│ └─ 平均折扣: 5.2%
│
│ 🍶 專屬價格商品 (3種)
│ ├─ 山崎18年: $20,000 (-$1,000, -5%)
│ ├─ 響21年: $32,000 (-$3,000, -9%)
│ └─ 白州12年: $6,500 (-$500, -7%)
│
│ 📈 價格趨勢
│ ├─ 過去6個月平均折扣: 5.5%
│ ├─ 毛利率: 65% (高於平均)
│ └─ 建議: 可維持現有價格策略
│
│ 💰 獲利分析
│ ├─ 總成本: $180,000
│ ├─ 總售價: $270,000 (專價)
│ ├─ 如用公版: $295,000
│ └─ 優惠成本: $25,000 (值得的投資)
└─────────────────────────┘
```

### **商品價格分析**
```
┌─ 山崎18年威士忌 (W001) - 價格分析 ─┐
│
│ 📊 價格概況
│ ├─ 公版價格: $21,000
│ ├─ 最高專價: $23,000 (C客戶, +9.5%)
│ ├─ 最低專價: $20,000 (A客戶, -4.8%)
│ └─ 平均售價: $21,200
│
│ 👥 客戶分佈 (總客戶: 15位)
│ ├─ 使用公版: 10位 (66.7%)
│ ├─ VIP專價: 3位 (20%)
│ ├─ 高價客戶: 2位 (13.3%)
│ └─ 加權平均: $20,950
│
│ 💡 定價建議
│ ├─ 公版價格合理，無需調整
│ ├─ VIP折扣適中，可維持客戶關係
│ ├─ 高價客戶可考慮再提高5%
│ └─ 整體毛利率: 62% (健康水準)
└─────────────────────────────────┘
```

---

## 🔄 **工作流程設計**

### **日常使用流程**
```
1. 老闆登入系統
   ↓
2. 進入商品管理 → 選擇商品
   ↓
3. 點擊「價格管理」頁籤
   ↓
4. 查看/設定客戶專屬價格
   ↓
5. 生成客戶專屬報價單
   ↓
6. 導出PDF或直接傳送給客戶
```

### **客戶詢價處理流程**
```
客戶詢價
   ↓
查看該客戶的專屬價格設定
   ↓
如有專價 → 使用專屬價格
如無專價 → 使用公版價格
   ↓
生成報價單並回覆客戶
   ↓
記錄報價歷史
```

---

## 📋 **資料表設計**

### **客戶專屬價格表**
```sql
CREATE TABLE customer_special_prices (
  id UUID PRIMARY KEY,
  product_id UUID REFERENCES products(id),
  customer_id UUID REFERENCES customers(id),
  special_price DECIMAL(10,2) NOT NULL,
  discount_amount DECIMAL(10,2),
  discount_rate DECIMAL(5,2),
  reason TEXT,
  effective_date DATE,
  expires_at DATE,
  is_active BOOLEAN DEFAULT true,
  notes TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  UNIQUE(product_id, customer_id)
);
```

### **報價單表**
```sql
CREATE TABLE quotations (
  id UUID PRIMARY KEY,
  quotation_number VARCHAR(20) UNIQUE, -- QT20250915001
  customer_id UUID REFERENCES customers(id),
  quotation_date DATE,
  valid_until DATE,
  template VARCHAR(20),
  status VARCHAR(20),
  notes TEXT,
  total_amount DECIMAL(12,2),
  created_at TIMESTAMP DEFAULT NOW(),
  sent_at TIMESTAMP,
  viewed_at TIMESTAMP,
  responded_at TIMESTAMP
);

CREATE TABLE quotation_items (
  id UUID PRIMARY KEY,
  quotation_id UUID REFERENCES quotations(id),
  product_id UUID REFERENCES products(id),
  quantity INTEGER,
  unit_price DECIMAL(10,2),
  total_price DECIMAL(10,2),
  is_special_price BOOLEAN DEFAULT false,
  discount_amount DECIMAL(10,2)
);
```

---

## 🎯 **開發重點提醒**

### **必須實現的功能**
- [ ] 商品公版價格設定
- [ ] 客戶專屬價格管理
- [ ] 客戶分級系統
- [ ] 報價單生成 (PDF/Excel)
- [ ] 價格歷史記錄
- [ ] 價格分析報表
- [ ] 權限嚴格控制

### **UI/UX要點**
- [ ] 介面要直觀易用
- [ ] 快速查找客戶和商品
- [ ] 價格變更要有確認機制
- [ ] 報價單樣式要專業
- [ ] 支援批量操作

### **安全要點**
- [ ] 只有超級管理員可存取
- [ ] API權限嚴格檢查
- [ ] 敏感資料不可外洩
- [ ] 操作日誌記錄

**這個系統將讓老闆完全掌控客戶關係和定價策略！** 💼✨