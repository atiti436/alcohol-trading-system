# 預購系統使用手冊

> 📅 版本：v1.0
> 🎯 完成日期：2025-10-04
> 📝 系統進度：80%（後端核心功能完成）

---

## 📋 目錄

1. [系統概述](#系統概述)
2. [核心功能](#核心功能)
3. [業務流程](#業務流程)
4. [功能操作指南](#功能操作指南)
5. [API 使用說明](#api-使用說明)
6. [常見問題 FAQ](#常見問題-faq)

---

## 系統概述

### 業務場景

預購系統專為處理「預訂未到貨商品」的業務場景設計，支援：

- 客戶預購未到貨商品（例如：山崎 2025 年版）
- 不收訂金，等商品到貨再通知客戶
- 同一商品可能有多個客戶預購
- 進貨時可能有商品毀損，需要智能分配
- 自動處理缺貨追蹤和補貨

### 核心能力

✅ **預購訂單管理** - 建立預購單不檢查庫存
✅ **統計彙總** - 同商品多筆訂單彙總，方便進貨規劃
✅ **批次轉換** - 商品到貨後批次處理預購單
✅ **自動轉換** - 進貨收貨時自動轉換預購單
✅ **毀損處理** - 自動調撥毀損商品到盒損變體（00X）
✅ **智能分配** - 庫存不足時智能分配（3 種策略）
✅ **缺貨追蹤** - 記錄缺貨，優先補貨
✅ **補貨自動化** - 進貨時自動補足缺貨訂單

---

## 核心功能

### 1. 預購訂單狀態流轉

```
PREORDER (預購中)
   │
   ├─ 庫存充足 → CONFIRMED (已確認)
   │                 │
   │                 └→ SHIPPED → DELIVERED
   │
   ├─ 庫存不足 → PARTIALLY_CONFIRMED (部分確認)
   │                 │
   │                 └→ 建立 BACKORDER 記錄
   │
   └─ 取消 → CANCELLED
```

### 2. 智能分配策略

**按比例分配（PROPORTIONAL）**
- 每個訂單按需求佔總需求的比例分配
- 適用：公平分配，每個客戶都少拿一點

**按優先級分配（PRIORITY）**
- VIP 客戶優先滿足
- 下單時間早的優先
- 適用：照顧 VIP 或重要客戶

**先到先得（FCFS）**
- 嚴格按下單時間排序
- 先下單的先滿足
- 適用：公平競爭，時間優先

### 3. 毀損處理

進貨時如有毀損商品：
- 自動調撥到盒損變體（變體類型 `00X`）
- 盒損商品價格自動計算為原價 80%
- 建立庫存異動記錄
- 可用庫存扣除毀損數量

### 4. 自動化流程

**進貨收貨時自動執行：**
1. 毀損商品調撥（如有）
2. 優先補足 BACKORDER（按優先級）
3. 轉換剩餘預購單（FIFO 庫存策略）

---

## 業務流程

### 流程 1：正常預購流程

```
1. 業務建立預購單（PREORDER）
   ↓
2. 商品到貨，進貨收貨
   ↓
3. 系統自動轉換預購單（CONFIRMED）
   ↓
4. 預留庫存
   ↓
5. 出貨給客戶
```

### 流程 2：毀損分配流程

```
1. 進貨 20 個，毀損 5 個，可用 15 個
   ↓
2. 系統自動：
   - 毀損 5 個 → 調撥到盒損變體（00X）
   - 檢測預購需求 20 個
   - 庫存不足，計算分配建議
   ↓
3. 執行智能分配（選擇策略）
   ↓
4. 結果：
   - 完全滿足 → CONFIRMED
   - 部分滿足 → PARTIALLY_CONFIRMED
   - 缺貨部分 → 建立 BACKORDER
```

### 流程 3：補貨流程

```
1. 存在 BACKORDER 記錄
   ↓
2. 下次進貨相同商品
   ↓
3. 系統自動：
   - 檢查待補貨的 BACKORDER
   - 按優先級補貨
   - 標記 BACKORDER 為 RESOLVED
   - 更新訂單狀態為 CONFIRMED
   ↓
4. 完成補貨
```

---

## 功能操作指南

### 1. 建立預購單

**操作步驟：**
1. 進入「銷售管理」
2. 點擊「新增銷售單」下拉選單
3. 選擇「預購單（未到貨）」
4. 填寫：
   - 客戶資訊
   - 商品（庫存為 0 也可以）
   - 數量
   - 預計到貨日
5. 儲存

**結果：**
- 訂單狀態：`PREORDER`
- 不會檢查庫存
- 不會預留庫存

### 2. 查看預購統計

**操作步驟：**
1. 進入「銷售管理 → 預購統計彙總」
2. 查看以下資訊：
   - **按商品彙總**：每個商品的總需求、訂單數、客戶數
   - **按客戶彙總**：每個客戶的所有預購單
   - **時間軸視圖**：按預計到貨日分組

**用途：**
- 了解需要進多少貨
- 查詢某客戶的所有預購
- 按到貨日規劃進貨

### 3. 批次轉換預購單

**操作步驟：**
1. 進入「預購統計彙總」
2. 在商品彙總表中，點擊展開商品
3. 勾選要轉換的預購單
4. 點擊「批次轉換」按鈕
5. 確認執行

**系統會：**
- 檢查每筆訂單的庫存
- 自動選擇 A 版變體（如未指定）
- 預留庫存（FIFO 策略）
- 更新訂單狀態為 `CONFIRMED`

**結果顯示：**
- ✅ 成功：庫存充足，成功轉換
- ⚠️ 警告：成功轉換，但有自動選擇變體
- ❌ 失敗：庫存不足，無法轉換

### 4. 進貨收貨（自動處理）

**操作步驟：**
1. 進入「進貨管理」
2. 選擇已確認的進貨單
3. 點擊「收貨」
4. 填寫收貨資訊：
   - 實際收貨數量
   - 實際匯率
   - **毀損數量**（如有）
   - **毀損類型**（運輸損壞/品質問題等）
5. 確認收貨

**系統自動執行：**
1. 毀損商品調撥到 00X 變體
2. 更新庫存
3. 檢查並補足 BACKORDER（優先級高的優先）
4. 轉換剩餘的預購單

**訊息範例：**
```
收貨完成，庫存已更新，
並自動補足了 2 筆缺貨，
並自動轉換了 5 筆預購單
```

### 5. 查看缺貨記錄

**API 端點：**
```
GET /api/backorders?status=PENDING&groupBy=variant
```

**參數：**
- `status`: `PENDING` | `RESOLVED` | `CANCELLED`
- `groupBy`: `variant` | `customer`
- `variantId`: 篩選特定變體
- `customerId`: 篩選特定客戶

**回傳資料：**
- 按商品彙總：顯示每個商品的總缺貨量
- 按客戶彙總：顯示每個客戶的缺貨情況
- 包含優先級、下單時間等資訊

---

## API 使用說明

### 1. 分配建議 API

**端點：** `POST /api/sales/preorders/allocate`

**用途：** 計算分配建議，不實際執行

**請求：**
```json
{
  "variantId": "variant_123",
  "availableStock": 15,
  "strategy": "PROPORTIONAL"  // PROPORTIONAL | PRIORITY | FCFS
}
```

**回應：**
```json
{
  "success": true,
  "data": {
    "variantId": "variant_123",
    "availableStock": 15,
    "strategy": "PROPORTIONAL",
    "allocation": [
      {
        "saleId": "sale_1",
        "saleNumber": "SA-001",
        "customerName": "客戶A",
        "requestedQuantity": 8,
        "allocatedQuantity": 6,
        "shortageQuantity": 2,
        "fulfillmentRate": 0.75
      }
    ],
    "stats": {
      "totalRequested": 20,
      "totalAllocated": 15,
      "totalShortage": 5,
      "fullyFulfilled": 1,
      "partiallyFulfilled": 2,
      "notFulfilled": 0
    }
  }
}
```

### 2. 執行分配 API

**端點：** `POST /api/sales/preorders/execute-allocation`

**用途：** 根據分配結果執行實際的訂單更新和庫存預留

**請求：**
```json
{
  "variantId": "variant_123",
  "allocations": [
    {
      "saleId": "sale_1",
      "allocatedQuantity": 6,
      "shortageQuantity": 2
    },
    {
      "saleId": "sale_2",
      "allocatedQuantity": 5,
      "shortageQuantity": 0
    }
  ]
}
```

**回應：**
```json
{
  "success": true,
  "message": "分配完成：1 筆完全滿足，1 筆部分滿足",
  "data": {
    "confirmed": [...],
    "partiallyConfirmed": [...],
    "backorders": [...],
    "errors": []
  }
}
```

### 3. 缺貨追蹤 API

**查詢缺貨：** `GET /api/backorders?status=PENDING`

**建立缺貨：** `POST /api/backorders`
```json
{
  "sale_id": "sale_123",
  "variant_id": "variant_123",
  "shortage_quantity": 5,
  "priority": 100,
  "notes": "VIP 客戶優先"
}
```

**解決缺貨：** `POST /api/backorders/{id}/resolve`

**取消缺貨：** `DELETE /api/backorders/{id}/resolve`

---

## 常見問題 FAQ

**Q1: 預購單可以修改嗎？**
A: `PREORDER` 狀態下可以修改，轉為 `CONFIRMED` 後不建議修改（會影響庫存預留）。

**Q2: 客戶取消預購怎麼辦？**
A: 直接刪除或標記為 `CANCELLED`。如果已轉 `CONFIRMED`，需要釋放預留庫存。

**Q3: 毀損商品調撥到哪裡？**
A: 自動調撥到盒損變體（變體類型 `00X`），價格自動設為原價 80%。

**Q4: 如何選擇分配策略？**
A:
- **公平分配** → 按比例分配（PROPORTIONAL）
- **照顧VIP** → 按優先級分配（PRIORITY）
- **先到先得** → FCFS

**Q5: 補貨時會自動處理嗎？**
A: 是的！進貨收貨時會自動：
1. 優先補足 BACKORDER（按優先級）
2. 轉換剩餘預購單

**Q6: 如果庫存仍不足怎麼辦？**
A: 系統會：
1. 部分滿足訂單 → 標記為 `PARTIALLY_CONFIRMED`
2. 建立 BACKORDER 記錄
3. 下次進貨時優先補貨

**Q7: 可以手動調整分配嗎？**
A: 目前 API 已支援，前端 UI 待開發。可以：
1. 先調用分配建議 API 查看建議
2. 手動調整分配數量
3. 調用執行分配 API

**Q8: 變體類型 A/B/C 的定義？**
A: 目前系統使用自由文字 `variant_type`，ABC 分類已停用。盒損變體統一使用 `00X`。

---

## 系統限制與注意事項

### 目前已完成（後端）
✅ 預購訂單建立和管理
✅ 統計彙總（按商品/客戶/時間軸）
✅ 批次轉換
✅ 自動轉換（進貨時觸發）
✅ 毀損商品自動調撥
✅ 智能分配算法（3 種策略）
✅ 缺貨追蹤 API
✅ 補貨自動處理

### 待開發（前端 UI）
⏳ 分配對話框（AllocationModal）
⏳ 缺貨管理頁面
⏳ 通知系統（LINE/Email）

### 已知限制
- 變體類型命名需要統一規範
- 分配 UI 需要手動調整功能
- 通知系統待整合

---

## 技術架構

### 核心技術
- **Next.js 14** - App Router
- **Prisma ORM** - PostgreSQL
- **Transaction 管理** - 保證資料一致性
- **FIFO 庫存策略** - 先進先出

### 關鍵設計
- 所有批次操作使用 Transaction
- 優先級排序：BACKORDER > 預購單
- 毀損調撥自動化
- 詳細的結果回報和錯誤處理

---

## 更新紀錄

**v1.0 (2025-10-04)**
- ✅ Phase 1: 基礎預購功能
- ✅ Phase 2: 預購統計彙總
- ✅ Phase 3: 批次轉換功能
- ✅ Phase 4: 毀損處理和智能分配（後端 80%）
- ✅ Phase 5: 缺貨追蹤和補貨
- ✅ Phase 7: 自動化和優化
- ⏳ Phase 6: 通知系統（待開發）
- ⏳ Phase 8: 測試和上線（進行中）

---

*文檔版本：v1.0*
*最後更新：2025-10-04*
*作者：Claude Code*
