# 🎯 系統驗收標準

## 🔒 核心安全要求

### 投資方數據隔離 (最高優先級)
```
驗收標準：
✅ 投資方角色登入後，所有API回傳的銷售數據必須：
   - 只包含displayPrice (調整後價格)
   - 不包含actualPrice (真實收取價格)
   - 不包含commission (老闆傭金)
   - 不包含personalPurchases (個人調貨)

✅ 投資方無法存取以下API端點：
   - /api/sales/actual-price
   - /api/purchases/personal
   - /api/reports/commission
   - /api/reports/full-profit

✅ 資料庫查詢必須包含角色過濾：
   - WHERE子句包含role檢查
   - 敏感欄位自動NULL處理
   - 審計日誌記錄所有存取
```

### 權限控制驗證
```
測試案例：
1. 投資方嘗試存取超級管理員API → 403 Forbidden
2. 員工嘗試查看獲利報表 → 403 Forbidden
3. 未登入使用者存取任何API → 401 Unauthorized
4. JWT token過期 → 自動重新導向登入

預期結果：
□ 所有權限檢查正確運作
□ 錯誤訊息不洩漏敏感資訊
□ 日誌記錄異常存取嘗試
```

## 💰 雙重價格系統驗證

### 銷售數據顯示邏輯
```
場景：山崎18年銷售
- 成本：$800
- 投資方顯示價格：$1,000
- 實際收取價格：$1,200
- 老闆傭金：$200

投資方API回傳：
{
  "productName": "山崎18年威士忌",
  "cost": 800,
  "salePrice": 1000,  // 只顯示這個價格
  "profit": 200,
  "commission": null   // 必須為null
}

超級管理員API回傳：
{
  "productName": "山崎18年威士忌",
  "cost": 800,
  "displayPrice": 1000,    // 投資方看到的
  "actualPrice": 1200,     // 真實收取
  "commission": 200,       // 老闆傭金
  "investorProfit": 200    // 投資方獲利
}

驗收標準：
□ 投資方永遠看不到actualPrice和commission
□ 計算邏輯正確無誤
□ 資料一致性檢查通過
```

## 🧮 成本計算驗證

### AI報單辨識與成本計算
```
測試數據：
- 商品：白鶴清酒 720ml 15度
- 日幣單價：¥800
- 匯率：0.21
- 數量：12瓶
- 損耗類型：分別測試

預期計算結果：
基礎稅金計算：
1. 台幣成本：¥800 × 0.21 = $168/瓶
2. 關稅(20%)：$168 × 0.2 = $34/瓶
3. 菸酒稅：0.72L × 15度 × 7元 = $76/瓶
4. 營業稅：($168+$34+$76) × 0.05 = $14/瓶
5. 基礎成本：$292/瓶
6. 總成本：$292 × 12 = $3,504

損耗測試：
- 無抽檢：可售12瓶，單價$292/瓶
- 一般抽檢：消滅1瓶 → 可售11瓶，單價$318/瓶
- 輻射抽檢：消滅2瓶 → 可售10瓶，單價$350/瓶
- 破損3瓶：消滅3瓶 → 可售9瓶，單價$389/瓶

驗收標準：
□ AI辨識準確率 > 85%
□ 成本計算結果正確
□ 損耗分攤邏輯正確（四種情況）
□ 匯率處理無誤
```

### 額外費用分攤
```
測試案例：
- 基礎成本：$3,504
- 運費：$500
- 報驗費：$300
- 商港服務費：$200
- 總額外費用：$1,000

分攤方式測試：
1. 按金額比例：每瓶分攤 = $1,000 × (單瓶成本/總成本)
2. 按數量平均：每瓶分攤 = $1,000 ÷ 9 = $111
3. 按重量分配：每瓶分攤 = $1,000 × (單瓶重量/總重量)

驗收標準：
□ 三種分攤方式計算正確
□ 分攤結果四捨五入至整數
□ 總和等於原始額外費用
```

## 🏪 商品變體系統驗證

### 變體管理邏輯
```
測試案例：山崎18年威士忌
主品號：W001

變體測試：
- W001-A (一般版) → 12瓶
- W001-C (100周年版) → 5瓶
- W001-X (損傷品) → 2瓶

庫存調撥測試：
1. 初始：W001-A 12瓶
2. 發現損傷：調撥 2瓶 → W001-X
3. 結果：W001-A 10瓶, W001-X 2瓶

驗收標準：
□ 變體代碼生成正確
□ 庫存調撥邏輯正確
□ 成本繼承無誤
□ 搜尋功能包含所有變體
```

### 智慧搜尋功能
```
測試案例：
輸入："山崎"

期望結果：
1. 精確匹配：W001 山崎18年威士忌
2. 變體展開：W001-A, W001-C, W001-X
3. 相關商品：W025 山崎12年威士忌
4. 排序邏輯：庫存數量 → 銷售頻率 → 字母順序

驗收標準：
□ 搜尋結果完整
□ 排序邏輯正確
□ 響應時間 < 500ms
□ 支援模糊搜尋
```

## 📱 LINE BOT功能驗證

### 成本計算功能
```
測試對話：
用戶："白鶴清酒 720ml 15度 日幣800 匯率0.21"

期望BOT回應：
🍶 白鶴清酒成本計算
📋 輸入資料：
├── 容量：720ml
├── 酒精度：15%
├── 日幣單價：¥800
├── 匯率：0.21
└── 輻射檢查：非輻射商品

💰 成本計算：
├── 台幣成本：$168
├── 關稅：$34
├── 菸酒稅：$76
├── 營業稅：$14
└── 總成本：$292/瓶

驗收標準：
□ 語言解析正確
□ 計算結果準確
□ 回應格式友善
□ 響應時間 < 3秒
```

### 報價記錄功能
```
測試流程：
1. 用戶："報價給王小姐 白鶴清酒 1200"
2. BOT記錄報價
3. 用戶："王小姐報價記錄"
4. BOT顯示歷史記錄

驗收標準：
□ 報價記錄正確保存
□ 歷史查詢功能正常
□ 客戶分析準確
□ 成交率計算正確
```

## 📊 報表系統驗證

### 投資方報表
```
測試數據：
- 投資項目：10筆銷售
- 總營收：$50,000 (顯示價格)
- 總成本：$35,000
- 總獲利：$15,000

投資方報表內容：
□ 只顯示投資項目
□ 使用displayPrice計算
□ 不包含個人調貨
□ 不顯示真實傭金

驗收標準：
□ 數據過濾正確
□ 計算結果準確
□ 圖表顯示清晰
□ 匯出功能正常
```

### 完整報表 (超級管理員)
```
包含所有數據：
□ 投資項目 + 個人調貨
□ 真實價格 + 顯示價格
□ 傭金明細 + 分潤計算
□ 開銷分攤 + 成本分析

驗收標準：
□ 數據完整性檢查
□ 多維度分析正確
□ 圖表互動功能
□ 時間範圍篩選
```

## 🔧 系統性能要求

### 頁面載入性能
```
效能標準：
□ 首頁載入 < 2秒
□ 商品搜尋 < 500ms
□ 報表生成 < 5秒
□ AI辨識 < 30秒

測試環境：
- 網路：標準寬頻
- 設備：中等效能電腦
- 瀏覽器：Chrome最新版
- 數據量：1000筆商品，5000筆交易
```

### 併發處理能力
```
負載測試：
□ 10個用戶同時操作
□ 100筆併發查詢
□ 大檔案上傳處理
□ 長時間運行穩定性

驗收標準：
□ 無記憶體洩漏
□ 資料庫連線正常
□ 錯誤處理完善
□ 日誌記錄完整
```

## 📚 文檔完整性檢查

### 技術文檔
```
必要文檔清單：
□ API接口文檔 (Swagger)
□ 資料庫Schema文檔
□ 部署指南
□ 維護手冊
□ 故障排除指南
□ 安全設定說明

品質標準：
□ 範例代碼可執行
□ 步驟描述清晰
□ 截圖更新及時
□ 版本資訊正確
```

### 使用者文檔
```
使用者手冊：
□ 角色功能說明
□ 操作流程指南
□ 常見問題FAQ
□ 商業邏輯說明

訓練材料：
□ 影片教學
□ 操作演示
□ 最佳實踐案例
□ 注意事項說明
```

## ✅ 最終驗收檢查清單

### 功能完整性
- [ ] 所有模組功能正常
- [ ] 用戶角色權限正確
- [ ] 數據隔離無漏洞
- [ ] 計算邏輯準確無誤
- [ ] LINE BOT整合正常

### 安全性檢查
- [ ] 投資方數據完全隔離
- [ ] API權限控制嚴格
- [ ] 敏感資訊加密保護
- [ ] 審計日誌完整記錄
- [ ] 安全漏洞掃描通過

### 性能表現
- [ ] 頁面載入符合標準
- [ ] 搜尋響應迅速
- [ ] 併發處理穩定
- [ ] 記憶體使用合理
- [ ] 資料庫查詢優化

### 用戶體驗
- [ ] 操作流程直觀
- [ ] 錯誤提示友善
- [ ] 響應式設計適配
- [ ] 無障礙功能支援
- [ ] 多瀏覽器相容

### 維護性
- [ ] 代碼結構清晰
- [ ] 註釋文檔完整
- [ ] 測試覆蓋率充足
- [ ] 部署流程自動化
- [ ] 監控告警設定

**通過所有檢查項目後，系統即可正式交付使用！** 🚀