# è³‡æ–™é©—è­‰è¦å‰‡ (Data Validation Rules)

æœ¬æ–‡ä»¶å®šç¾©ç³»çµ±çš„è³‡æ–™é©—è­‰è¦å‰‡ï¼Œé˜²æ­¢éŒ¯èª¤è³‡æ–™é€²å…¥ç³»çµ±ã€‚æ‰€æœ‰èèŸ»é–‹ç™¼æ™‚å¿…é ˆå¯¦ä½œé€™äº›é©—è­‰ã€‚

## ğŸ›¡ï¸ é©—è­‰åŸå‰‡

1. **é˜²å‘†å„ªå…ˆ**: ç³»çµ±è¦æ¯”ä½¿ç”¨è€…è°æ˜ï¼Œè‡ªå‹•é˜²æ­¢å¸¸è¦‹éŒ¯èª¤
2. **å‹å–„æç¤º**: éŒ¯èª¤è¨Šæ¯è¦æ¸…æ¥šå‘Šè¨´ä½¿ç”¨è€…æ€éº¼æ”¹æ­£
3. **å³æ™‚é©—è­‰**: è¼¸å…¥æ™‚å°±æª¢æŸ¥ï¼Œä¸è¦ç­‰åˆ°æäº¤æ‰å ±éŒ¯
4. **ä¼ºæœå™¨ç«¯å¿…æª¢**: å‰ç«¯é©—è­‰å¯ä»¥ç¹éï¼Œå¾Œç«¯APIå¿…é ˆå†æª¢æŸ¥ä¸€æ¬¡

---

## ğŸ“‹ å®¢æˆ¶è³‡æ–™é©—è­‰è¦å‰‡

| æ¬„ä½ | é©—è­‰è¦å‰‡ | éŒ¯èª¤è¨Šæ¯ | ç¯„ä¾‹ |
|------|----------|----------|------|
| `customer_code` | å¿…å¡«ï¼›æ ¼å¼`C00001`ï¼›ä¸å¯é‡è¤‡ | "å®¢æˆ¶ä»£ç¢¼æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨C00001æ ¼å¼" | âœ… `C00001` âŒ `CUS001` |
| `name` | å¿…å¡«ï¼›1-100å­—ï¼›ä¸å¯ç©ºç™½ | "å®¢æˆ¶åç¨±å¿…å¡«ï¼Œè«‹è¼¸å…¥1-100å­—" | âœ… `æ»¿å¸†æ´‹è¡Œ` âŒ `   ` |
| `email` | é¸å¡«ï¼›Emailæ ¼å¼ | "è«‹è¼¸å…¥æ­£ç¢ºçš„Emailæ ¼å¼" | âœ… `test@example.com` âŒ `abc123` |
| `phone` | é¸å¡«ï¼›å°ç£æ‰‹æ©Ÿæ ¼å¼ | "è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼" | âœ… `0912-345-678` âŒ `abc123` |
| `tax_id` | é¸å¡«ï¼›8ä½æ•¸å­— | "çµ±ä¸€ç·¨è™Ÿå¿…é ˆæ˜¯8ä½æ•¸å­—" | âœ… `12345678` âŒ `123456789` |
| `credit_limit` | é¸å¡«ï¼›â‰¥0çš„æ•¸å­— | "ä¿¡ç”¨é¡åº¦ä¸èƒ½æ˜¯è² æ•¸" | âœ… `100000` âŒ `-1000` |

---

## ğŸ¶ ç”¢å“è³‡æ–™é©—è­‰è¦å‰‡

| æ¬„ä½ | é©—è­‰è¦å‰‡ | éŒ¯èª¤è¨Šæ¯ | ç¯„ä¾‹ |
|------|----------|----------|------|
| `product_code` | å¿…å¡«ï¼›æ ¼å¼`P00001`ï¼›ä¸å¯é‡è¤‡ | "ç”¢å“ç·¨è™Ÿæ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨P00001æ ¼å¼" | âœ… `P00001` âŒ `PROD001` |
| `name_zh` | å¿…å¡«ï¼›1-200å­— | "ä¸­æ–‡å“åå¿…å¡«ï¼Œè«‹è¼¸å…¥1-200å­—" | âœ… `å±±å´18å¹´å¨å£«å¿Œ` âŒ `   ` |
| `volume_ml` | å¿…å¡«ï¼›1-10000çš„æ•¸å­— | "å®¹é‡å¿…é ˆåœ¨1-10000æ¯«å‡ä¹‹é–“" | âœ… `700` âŒ `0` âŒ `999999` |
| `alc_percentage` | å¿…å¡«ï¼›0-100çš„æ•¸å­— | "é…’ç²¾åº¦å¿…é ˆåœ¨0-100%ä¹‹é–“" | âœ… `43` âŒ `150` âŒ `-5` |
| `weight_kg` | å¿…å¡«ï¼›0.1-50çš„æ•¸å­— | "å•†å“é‡é‡å¿…é ˆåœ¨0.1-50å…¬æ–¤ä¹‹é–“" | âœ… `1.2` âŒ `0` âŒ `100` |
| `standard_price` | å¿…å¡«ï¼›â‰¥1çš„æ•¸å­— | "æ¨™æº–å”®åƒ¹å¿…é ˆå¤§æ–¼0å…ƒ" | âœ… `21000` âŒ `0` âŒ `-1000` |
| `current_price` | å¿…å¡«ï¼›â‰¥1çš„æ•¸å­— | "ç›®å‰å”®åƒ¹å¿…é ˆå¤§æ–¼0å…ƒ" | âœ… `20000` âŒ `0` |
| `min_price` | å¿…å¡«ï¼›â‰¥1ä¸”â‰¤current_price | "æœ€ä½é™åƒ¹ä¸èƒ½é«˜æ–¼ç›®å‰å”®åƒ¹" | âœ… `18000` âŒ `25000` |

### ğŸ” ç”¢å“è®Šé«”é©—è­‰è¦å‰‡

| æ¬„ä½ | é©—è­‰è¦å‰‡ | éŒ¯èª¤è¨Šæ¯ | ç¯„ä¾‹ |
|------|----------|----------|------|
| `variant_code` | å¿…å¡«ï¼›æ ¼å¼`P00001-A`ï¼›ä¸å¯é‡è¤‡ | "è®Šé«”ç·¨è™Ÿæ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨P00001-Aæ ¼å¼" | âœ… `P00001-A` âŒ `P00001_A` |
| `variant_type` | å¿…å¡«ï¼›åªèƒ½æ˜¯A,B,C,D,X | "è®Šé«”é¡å‹åªèƒ½æ˜¯A/B/C/D/X" | âœ… `A` âŒ `Z` |
| `stock_quantity` | å¿…å¡«ï¼›â‰¥0çš„æ•´æ•¸ | "åº«å­˜æ•¸é‡ä¸èƒ½æ˜¯è² æ•¸" | âœ… `50` âŒ `-10` âŒ `10.5` |
| `discount_rate` | é¸å¡«ï¼›0-1çš„æ•¸å­— | "æŠ˜æ‰£ç‡å¿…é ˆåœ¨0-100%ä¹‹é–“" | âœ… `0.8` âŒ `1.5` âŒ `-0.2` |

---

## ğŸ’° éŠ·å”®è³‡æ–™é©—è­‰è¦å‰‡

| æ¬„ä½ | é©—è­‰è¦å‰‡ | éŒ¯èª¤è¨Šæ¯ | ç¯„ä¾‹ |
|------|----------|----------|------|
| `sales_order_number` | å¿…å¡«ï¼›æ ¼å¼`SO-YYYYMMDD-001` | "éŠ·å”®å–®è™Ÿæ ¼å¼éŒ¯èª¤" | âœ… `SO-20250916-001` |
| `customer_id` | å¿…å¡«ï¼›å¿…é ˆå­˜åœ¨æ–¼å®¢æˆ¶è³‡æ–™ä¸­ | "æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶ï¼Œè«‹é‡æ–°é¸æ“‡" | âœ… æœ‰æ•ˆå®¢æˆ¶ID |
| `quantity` | å¿…å¡«ï¼›â‰¥1çš„æ•´æ•¸ | "æ•¸é‡å¿…é ˆå¤§æ–¼0" | âœ… `5` âŒ `0` âŒ `-2` |
| `unit_display_price` | å¿…å¡«ï¼›â‰¥1çš„æ•¸å­— | "é¡¯ç¤ºåƒ¹æ ¼å¿…é ˆå¤§æ–¼0å…ƒ" | âœ… `1000` âŒ `0` |
| `unit_actual_price` | å¿…å¡«ï¼›â‰¥unit_display_price | "å¯¦éš›åƒ¹æ ¼ä¸èƒ½ä½æ–¼é¡¯ç¤ºåƒ¹æ ¼" | âœ… `1200` âŒ `800` |
| `delivery_date` | é¸å¡«ï¼›â‰¥ä»Šå¤©çš„æ—¥æœŸ | "äº¤è²¨æ—¥æœŸä¸èƒ½æ˜¯éå»æ™‚é–“" | âœ… æ˜å¤©çš„æ—¥æœŸ âŒ æ˜¨å¤© |

---

## ğŸª æ¡è³¼è³‡æ–™é©—è­‰è¦å‰‡

| æ¬„ä½ | é©—è­‰è¦å‰‡ | éŒ¯èª¤è¨Šæ¯ | ç¯„ä¾‹ |
|------|----------|----------|------|
| `purchase_order_number` | å¿…å¡«ï¼›æ ¼å¼`PO-YYYYMMDD-001` | "æ¡è³¼å–®è™Ÿæ ¼å¼éŒ¯èª¤" | âœ… `PO-20250916-001` |
| `supplier` | å¿…å¡«ï¼›1-100å­— | "ä¾›æ‡‰å•†åç¨±å¿…å¡«" | âœ… `æ—¥æœ¬é…’å•†æ ªå¼æœƒç¤¾` |
| `currency` | å¿…å¡«ï¼›3ä½è²¨å¹£ä»£ç¢¼ | "è²¨å¹£ä»£ç¢¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨å¦‚JPY/USDæ ¼å¼" | âœ… `JPY` âŒ `æ—¥å¹£` |
| `exchange_rate` | é¸å¡«ï¼›>0çš„æ•¸å­— | "åŒ¯ç‡å¿…é ˆå¤§æ–¼0" | âœ… `0.23` âŒ `0` âŒ `-0.5` |
| `unit_price_foreign` | å¿…å¡«ï¼›>0çš„æ•¸å­— | "å¤–å¹£å–®åƒ¹å¿…é ˆå¤§æ–¼0" | âœ… `8000` âŒ `0` |

---

## ğŸ”’ æ¬Šé™ç›¸é—œé©—è­‰

### è§’è‰²é©—è­‰
```typescript
// è§’è‰²å¿…é ˆæ˜¯ä»¥ä¸‹ä¹‹ä¸€
enum UserRole {
  SUPER_ADMIN = 'SUPER_ADMIN',
  INVESTOR = 'INVESTOR', 
  EMPLOYEE = 'EMPLOYEE'
}

// é©—è­‰è¦å‰‡
const validateUserRole = (role: string): boolean => {
  return Object.values(UserRole).includes(role as UserRole);
}
```

### æŠ•è³‡æ–¹éš”é›¢é©—è­‰
```typescript
// æŠ•è³‡æ–¹åªèƒ½å­˜å–è‡ªå·±çš„è³‡æ–™
const validateInvestorAccess = (userRole: string, investorId: string, dataInvestorId: string): boolean => {
  if (userRole === 'SUPER_ADMIN') return true;
  if (userRole === 'INVESTOR') return investorId === dataInvestorId;
  return false;
}
```

---

## ğŸ’» æŠ€è¡“å¯¦ä½œç¯„ä¾‹

### å‰ç«¯é©—è­‰ç¯„ä¾‹ (React + Ant Design)
```typescript
import { Form, Input, InputNumber, message } from 'antd';

const ProductForm = () => {
  const [form] = Form.useForm();

  return (
    <Form form={form} onFinish={handleSubmit}>
      <Form.Item
        name="product_code"
        label="ç”¢å“ç·¨è™Ÿ"
        rules={[
          { required: true, message: 'ç”¢å“ç·¨è™Ÿå¿…å¡«' },
          { pattern: /^P\d{5}$/, message: 'ç”¢å“ç·¨è™Ÿæ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨P00001æ ¼å¼' }
        ]}
      >
        <Input placeholder="P00001" />
      </Form.Item>
      
      <Form.Item
        name="alc_percentage"
        label="é…’ç²¾æ¿ƒåº¦(%)"
        rules={[
          { required: true, message: 'é…’ç²¾æ¿ƒåº¦å¿…å¡«' },
          { type: 'number', min: 0, max: 100, message: 'é…’ç²¾åº¦å¿…é ˆåœ¨0-100%ä¹‹é–“' }
        ]}
      >
        <InputNumber min={0} max={100} />
      </Form.Item>
      
      <Form.Item
        name="standard_price"
        label="æ¨™æº–å”®åƒ¹"
        rules={[
          { required: true, message: 'æ¨™æº–å”®åƒ¹å¿…å¡«' },
          { type: 'number', min: 1, message: 'æ¨™æº–å”®åƒ¹å¿…é ˆå¤§æ–¼0å…ƒ' }
        ]}
      >
        <InputNumber min={1} formatter={value => `$ ${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')} />
      </Form.Item>
    </Form>
  );
};
```

### å¾Œç«¯APIé©—è­‰ç¯„ä¾‹ (Node.js + Express)
```typescript
import { body, validationResult } from 'express-validator';

// ç”¢å“è³‡æ–™é©—è­‰ä¸­é–“ä»¶
export const validateProduct = [
  body('product_code')
    .matches(/^P\d{5}$/)
    .withMessage('ç”¢å“ç·¨è™Ÿæ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨P00001æ ¼å¼'),
  body('name_zh')
    .isLength({ min: 1, max: 200 })
    .withMessage('ä¸­æ–‡å“åå¿…å¡«ï¼Œè«‹è¼¸å…¥1-200å­—'),
  body('volume_ml')
    .isInt({ min: 1, max: 10000 })
    .withMessage('å®¹é‡å¿…é ˆåœ¨1-10000æ¯«å‡ä¹‹é–“'),
  body('alc_percentage')
    .isFloat({ min: 0, max: 100 })
    .withMessage('é…’ç²¾åº¦å¿…é ˆåœ¨0-100%ä¹‹é–“'),
  body('standard_price')
    .isFloat({ min: 1 })
    .withMessage('æ¨™æº–å”®åƒ¹å¿…é ˆå¤§æ–¼0å…ƒ'),
];

// APIç«¯é»
app.post('/api/products', validateProduct, (req, res) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({ 
      success: false,
      error: {
        code: 'VALIDATION_ERROR',
        message: 'è³‡æ–™é©—è­‰å¤±æ•—',
        details: errors.array()
      }
    });
  }
  
  // è™•ç†æ­£ç¢ºçš„è³‡æ–™...
});
```

---

## ğŸ“± ç‰¹æ®Šé©—è­‰è¦å‰‡

### LINE Botè¼¸å…¥é©—è­‰
```typescript
// LINE Bot æˆæœ¬è¨ˆç®—è¼¸å…¥è§£æ
const parseLineMessage = (text: string) => {
  // ç¯„ä¾‹è¼¸å…¥: "ç™½é¶´æ¸…é…’ 720ml 15åº¦ æ—¥å¹£800 åŒ¯ç‡0.21"
  const regex = /(.+?)\s+(\d+)ml\s+(\d+(?:\.\d+)?)åº¦\s+æ—¥å¹£(\d+(?:\.\d+)?)\s+åŒ¯ç‡(\d+(?:\.\d+)?)/;
  const match = text.match(regex);
  
  if (!match) {
    throw new Error('æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨ï¼šå•†å“åç¨± å®¹é‡ml é…’ç²¾åº¦åº¦ æ—¥å¹£åƒ¹æ ¼ åŒ¯ç‡æ•¸å­—');
  }
  
  const [, name, volume, alc, jpyPrice, exchangeRate] = match;
  
  // é©—è­‰æ•¸å€¼ç¯„åœ
  if (Number(volume) < 1 || Number(volume) > 10000) {
    throw new Error('å®¹é‡å¿…é ˆåœ¨1-10000æ¯«å‡ä¹‹é–“');
  }
  if (Number(alc) < 0 || Number(alc) > 100) {
    throw new Error('é…’ç²¾åº¦å¿…é ˆåœ¨0-100%ä¹‹é–“');
  }
  if (Number(jpyPrice) <= 0) {
    throw new Error('æ—¥å¹£åƒ¹æ ¼å¿…é ˆå¤§æ–¼0');
  }
  if (Number(exchangeRate) <= 0) {
    throw new Error('åŒ¯ç‡å¿…é ˆå¤§æ–¼0');
  }
  
  return {
    name,
    volume_ml: Number(volume),
    alc_percentage: Number(alc),
    jpy_price: Number(jpyPrice),
    exchange_rate: Number(exchangeRate)
  };
};
```

---

## âš ï¸ é‡è¦æé†’

### çµ¦èèŸ»A (ç›£ç£) çš„æª¢æŸ¥æ¸…å–®ï¼š
- [ ] æ‰€æœ‰APIéƒ½æœ‰è¼¸å…¥é©—è­‰å—ï¼Ÿ
- [ ] éŒ¯èª¤è¨Šæ¯æ˜¯å¦å‹å–„æ˜“æ‡‚ï¼Ÿ
- [ ] å‰ç«¯å’Œå¾Œç«¯éƒ½æœ‰é©—è­‰å—ï¼Ÿ
- [ ] æŠ•è³‡æ–¹æ¬Šé™éš”é›¢æ˜¯å¦æ­£ç¢ºï¼Ÿ

### çµ¦èèŸ»B (å¯¦ä½œ) çš„å¯¦ä½œè¦é»ï¼š
- [ ] ä½¿ç”¨é©—è­‰å¥—ä»¶(å¦‚express-validator, Joiç­‰)
- [ ] å¯¦ä½œçµ±ä¸€çš„éŒ¯èª¤è™•ç†æ ¼å¼
- [ ] å‰ç«¯å³æ™‚é©—è­‰æå‡ä½¿ç”¨è€…é«”é©—
- [ ] è¨˜éŒ„é©—è­‰å¤±æ•—çš„å˜—è©¦(é˜²æ”»æ“Š)

### çµ¦è€é—†çš„æ“ä½œå»ºè­°ï¼š
- ğŸ”´ å¦‚æœçœ‹åˆ°éŒ¯èª¤è¨Šæ¯ï¼ŒæŒ‰ç…§æç¤ºä¿®æ­£å³å¯
- ğŸ”´ ç³»çµ±ä¸è®“æ‚¨è¼¸å…¥éŒ¯èª¤è³‡æ–™æ˜¯ç‚ºäº†ä¿è­·æ‚¨çš„è³‡æ–™å“è³ª
- ğŸ”´ å¦‚æœè¦ºå¾—é©—è­‰è¦å‰‡å¤ªåš´æ ¼ï¼Œå¯ä»¥è«‹èèŸ»èª¿æ•´

---

**æœ€å¾Œæ›´æ–°**: 2025/9/16  
**ç¶­è­·è²¬ä»»**: æ‰€æœ‰æˆ¿é–“éƒ½å¿…é ˆå¯¦ä½œç›¸å°æ‡‰çš„é©—è­‰è¦å‰‡  
**ç·Šæ€¥è¯çµ¡**: å¦‚æœé©—è­‰è¦å‰‡é˜»ç¤™æ­£å¸¸æ“ä½œï¼Œè«‹ç«‹å³å›å ±ä¿®æ­£