# 🤖 AI 接手指南 - 酒類交易系統

**唯一權威文檔 - AI必讀**

---

## 🎯 系統核心邏輯（30秒理解）

### 資金來源
- **COMPANY** = 投資方出錢
- **PERSONAL** = 老闆私人資金

### 雙重價格機制
- **display_price** = 投資方看到的價格
- **actual_price** = 實際收取價格
- **價差傭金** = actual_price - display_price = 老闆賺的

### 獲利分配
```
COMPANY資金商品賣出：
- 投資方得到：成本 + (display_price - 成本)
- 老闆得到：actual_price - display_price

PERSONAL資金商品賣出：
- 老闆得到：actual_price - 成本（全部）
```

---

## 📋 標準業務流程

### 1. 採購流程
```
新增採購單 → 選擇資金來源 → 採購單確認 → 收貨 → 庫存增加
```

### 2. 銷售流程
```
新增銷售單 → 檢查庫存 → 預留庫存 → 銷售確認 → 出貨 → 庫存減少 → 獲利分配
```

### 3. 關鍵計算
- **庫存計算**: `可售庫存 = 總庫存 - 預留庫存`
- **匯率計算**: `台幣金額 = 外幣金額 × 匯率`
- **加權平均成本**: `(原成本×原數量 + 新成本×新數量) ÷ 總數量`

---

## 🚫 重要限制

### 刪除規則
- **採購單**: 有收貨記錄 → 必須先撤銷收貨
- **銷售單**: 有出貨記錄 → 必須先撤銷出貨
- **商品**: 有庫存或交易記錄 → 禁止刪除

### 權限控制
- **INVESTOR**: 只能看COMPANY資金的資料，不能看actual_price
- **EMPLOYEE**: 可以操作但不能看個人調貨
- **SUPER_ADMIN**: 看全部

---

## 🔧 技術重點

### 資料庫欄位
- 一律使用 **snake_case** (product_name, total_amount)
- 前端介面可用 camelCase，但要轉換

### 關鍵API路徑
- 採購: `/api/purchases`
- 銷售: `/api/sales`
- 庫存: `/api/inventory`
- 商品: `/api/products`

### 狀態流程
```
採購: DRAFT → CONFIRMED → RECEIVED → COMPLETED
銷售: DRAFT → CONFIRMED → SHIPPED → DELIVERED
```

---

## ⚠️ 已知問題（優先修復）

1. **庫存假資料** - 需要重建庫存計算邏輯
2. **價格來源不統一** - 需要統一價格取得邏輯
3. **資金流追蹤缺失** - 需要完整記錄資金流向

---

## 📝 AI工作原則

### DO
- 修改前先讀這個文檔
- 遵循既有的業務邏輯
- 保持snake_case命名
- 維護雙重價格機制

### DON'T
- 不要破壞資金來源邏輯
- 不要讓投資方看到actual_price
- 不要直接刪除有關聯的資料
- 不要建立新的複雜文檔

---

**🎯 記住：這是唯一權威文檔，有疑問優先參考這裡！**